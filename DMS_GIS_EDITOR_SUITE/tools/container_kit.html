<!doctype html>
<html>
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DMS ‚Ä¢ GIS Container Kit</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html,body,#map{height:100%;margin:0}
  .panel{position:fixed;left:12px;top:12px;z-index:1000;width:360px;
         max-width:min(92vw,420px);height:calc(100% - 24px);overflow:auto;
         background:#0f2330;color:#eaf1f5;padding:14px;border-radius:12px;
         box-shadow:0 10px 28px rgba(0,0,0,.35);font:14px system-ui}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button{background:#1f8f5f;border:0;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.secondary{background:#2b3c48} .danger{background:#b84040}
  input[type=file]{display:block;margin-top:6px} .mut{color:#9fb1be} .small{font-size:12px}
</style>
</head>
<body>
<div id="map"></div>
<div class="panel">
  <b>GIS Container Kit</b>
  <div class="small mut" style="margin-top:4px">Carica <code>container.json</code> (px) e <code>gcp.json</code> (4 angoli) e genera i GeoJSON.</div>
  <div class="row"><input id="fContainer" type="file" accept="application/json"></div>
  <div class="row"><input id="fGcp" type="file" accept="application/json"></div>
  <div class="row">
    <button id="btnApply">Applica GCP ‚Üí mappa</button>
    <button id="btnArea" class="secondary">‚¨áÔ∏è Area GeoJSON</button>
    <button id="btnStalls" class="secondary">‚¨áÔ∏è Stalls GeoJSON</button>
    <button id="btnClear" class="danger">üßπ Pulisci</button>
  </div>
  <div id="log" class="small mut" style="margin-top:8px"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map=L.map('map').setView([42.7633,11.1117],17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);
map.createPane('area'); map.getPane('area').style.zIndex=450;
map.createPane('stalls'); map.getPane('stalls').style.zIndex=460;

let container=null, gcpData=null, areaLayer=null, stallsLayer=null;
const logEl=document.getElementById('log');

document.getElementById('fContainer').onchange=async(e)=>{const f=e.target.files[0]; if(!f) return; container=JSON.parse(await f.text()); log('Container caricato.');};
document.getElementById('fGcp').onchange=async(e)=>{const f=e.target.files[0]; if(!f) return; gcpData=JSON.parse(await f.text()); log('GCP caricati.');};

document.getElementById('btnApply').onclick=()=>{
  if(!container||!gcpData) return alert('Carica prima container.json e gcp.json');
  const pxSize={w:gcpData.imageW,h:gcpData.imageH};
  const px=[{x:0,y:0},{x:pxSize.w,y:0},{x:pxSize.w,y:pxSize.h},{x:0,y:pxSize.h}];
  const ll=gcpData.gcp.map(p=>L.latLng(p.ll[0],p.ll[1]));
  const H=computeHomography(px.map(p=>({x:p.x,y:p.y})), ll.map(latLngToXY));

  if(areaLayer) map.removeLayer(areaLayer);
  const areaLatLngs=container.area_px.map(p=>fromXY(applyH(H,p[0],p[1])));
  areaLayer=L.polygon(areaLatLngs,{pane:'area',weight:1}).addTo(map);

  if(stallsLayer) map.removeLayer(stallsLayer);
  stallsLayer=L.featureGroup([], {pane:'stalls'}).addTo(map);
  (container.stalls_px||[]).forEach(s=>{
    const poly=s.poly.map(p=>fromXY(applyH(H,p[0],p[1])));
    const g=L.polygon(poly,{weight:1}); g.feature={type:'Feature',properties:{id:s.id}};
    g.bindTooltip(String(s.id),{direction:'center'}); stallsLayer.addLayer(g);
  });
  map.fitBounds(areaLayer.getBounds(),{padding:[24,24]});
  attachZoomStyling(map,stallsLayer,18);
  log('Georeferenziazione applicata.');
};

document.getElementById('btnArea').onclick=()=>{ if(!areaLayer) return; downloadJSON(areaLayer.toGeoJSON(),'area.geojson'); };
document.getElementById('btnStalls').onclick=()=>{ if(!stallsLayer) return; downloadJSON(stallsLayer.toGeoJSON(),'stalls.geojson'); };
document.getElementById('btnClear').onclick=()=>{ [areaLayer,stallsLayer].forEach(l=>l&&map.removeLayer(l)); areaLayer=stallsLayer=null; log('Mappa pulita.'); };

function log(m){const t=new Date().toTimeString().slice(0,8); logEl.textContent=`[${t}] ${m}\n`+logEl.textContent;}
const CRS=L.CRS.EPSG3857; function latLngToXY(ll){const p=CRS.project(ll); return {x:p.x,y:p.y};}
function fromXY(pt){return CRS.unproject(L.point(pt.x,pt.y));}
function solve(A,b){const n=A.length;for(let i=0;i<n;i++){let m=i;for(let r=i+1;r<n;r++)if(Math.abs(A[r][i])>Math.abs(A[m][i]))m=r;[A[i],A[m]]=[A[m],A[i]];[b[i],b[m]]=[b[m],b[i]];const d=A[i][i];for(let j=i;j<n;j++)A[i][j]/=d;b[i]/=d;for(let r=0;r<n;r++)if(r!==i){const f=A[r][i];for(let j=i;j<n;j++)A[r][j]-=f*A[i][j];b[r]-=f*b[i];}}return b;}
function computeHomography(pxs,wms){const A=[],b=[];for(let k=0;k<4;k++){const x=pxs[k].x,y=pxs[k].y,X=wms[k].x,Y=wms[k].y;A.push([x,y,1,0,0,0,-x*X,-y*X]);b.push(X);A.push([0,0,0,x,y,1,-x*Y,-y*Y]);b.push(Y);}const h=solve(A,b);return [[h[0],h[1],h[2]],[h[3],h[4],h[5]],[h[6],h[7],1]];}
function applyH(H,x,y){const w=H[2][0]*x+H[2][1]*y+H[2][2];const X=(H[0][0]*x+H[0][1]*y+H[0][2])/w;const Y=(H[1][0]*x+H[1][1]*y+H[1][2])/w;return {x:X,y:Y};}
function attachZoomStyling(map,layer,baseZoom){baseZoom=baseZoom||18;function restyle(){const s=Math.pow(2,map.getZoom()-baseZoom);layer.setStyle?.({weight:Math.max(0.5,1/s)});document.querySelectorAll('.leaflet-tooltip').forEach(el=>el.style.fontSize=`${Math.max(10,12/s)}px`);}map.on('zoomend',restyle);restyle();}
function downloadJSON(obj,name){const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href);}
</script>
</body>
</html>

