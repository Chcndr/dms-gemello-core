<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DMS • Overlay Editor v3 - Simple Debug</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    :root{
      --bg:#072C2E; --panel:#0E2830; --ink:#D5F0E6; --accent:#0FA3A3;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui}
    
    #map{width:100%;height:100vh;position:relative}
    
    .controls {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #0E2830;
      padding: 20px;
      border-radius: 8px;
      z-index: 2000;
      width: 320px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    button {
      background: var(--accent);
      border: none;
      color: #001b1c;
      padding: 12px;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin: 5px 0;
    }
    
    .debug {
      background: rgba(0,0,0,0.5);
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 0.85rem;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .debug-line {
      margin: 3px 0;
      color: #4CAF50;
    }
    
    input[type="range"] {
      width: 100%;
      margin: 10px 0;
    }
    
    label {
      display: block;
      margin: 10px 0 5px;
      color: #9AB8B3;
    }
    
    /* DRAGGABLE OVERLAY */
    .overlay-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transform-origin: center center;
      cursor: move;
      z-index: 1500;
      pointer-events: auto;
      border: 3px dashed yellow;
      background: rgba(255, 255, 0, 0.1);
    }
    
    .overlay-container img {
      display: block;
      width: 500px;
      user-select: none;
      -webkit-user-drag: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <h3 style="margin-top:0">🎨 Overlay Editor v3</h3>
    
    <button id="loadBtn">📂 Carica Overlay</button>
    
    <div class="debug" id="debugLog">
      <div class="debug-line">🚀 Sistema pronto</div>
    </div>
    
    <label>📏 Scala: <span id="scaleValue">1.0x</span></label>
    <input type="range" id="scaleSlider" min="0.5" max="3" step="0.1" value="1">
    
    <label>🔄 Rotazione: <span id="rotateValue">0°</span></label>
    <input type="range" id="rotateSlider" min="0" max="360" step="5" value="0">
    
    <label>👁️ Opacità: <span id="opacityValue">70%</span></label>
    <input type="range" id="opacitySlider" min="0" max="100" step="10" value="70">
    
    <button id="resetBtn">🔄 Reset Posizione</button>
    <button id="saveBtn" style="background: #30c36b;">💾 Salva Coordinate</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // DEBUG HELPER
    const debugLog = document.getElementById('debugLog');
    function log(msg, color = '#4CAF50') {
      const line = document.createElement('div');
      line.className = 'debug-line';
      line.style.color = color;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      debugLog.appendChild(line);
      debugLog.scrollTop = debugLog.scrollHeight;
      console.log(msg);
    }

    log('🗺️ Inizializzazione mappa...');
    
    // Initialize map
    const map = L.map('map', {
      center: [42.758, 11.114],
      zoom: 16,
      zoomControl: true,
      maxZoom: 22
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 22,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    log('✅ Mappa caricata');

    // Load market area
    fetch('data/grosseto_full.geojson')
      .then(r => r.json())
      .then(data => {
        const area = data.features.find(f => f.properties.kind === 'area');
        if (area) {
          L.geoJSON(area, {
            style: {
              color: '#2E7D32',
              fillColor: '#4CAF50',
              fillOpacity: 0.15,
              weight: 3
            }
          }).addTo(map);
          log('✅ Area mercato caricata');
        }
      })
      .catch(e => log('❌ Errore caricamento area: ' + e.message, '#E65454'));

    // Overlay state
    let overlayContainer = null;
    let overlayImg = null;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let currentX = 0;
    let currentY = 0;

    // Controls
    const loadBtn = document.getElementById('loadBtn');
    const scaleSlider = document.getElementById('scaleSlider');
    const rotateSlider = document.getElementById('rotateSlider');
    const opacitySlider = document.getElementById('opacitySlider');
    const resetBtn = document.getElementById('resetBtn');
    const saveBtn = document.getElementById('saveBtn');
    
    const scaleValue = document.getElementById('scaleValue');
    const rotateValue = document.getElementById('rotateValue');
    const opacityValue = document.getElementById('opacityValue');

    // LOAD OVERLAY
    loadBtn.addEventListener('click', () => {
      log('📂 Caricamento overlay...');
      loadOverlay('data/grosseto_pianta_transparent.png');
    });

    function loadOverlay(imageUrl) {
      log('🔧 Creazione container overlay...');
      
      // Remove existing
      if (overlayContainer) {
        overlayContainer.remove();
        log('🗑️ Overlay precedente rimosso');
      }

      // Create container
      overlayContainer = document.createElement('div');
      overlayContainer.className = 'overlay-container';
      
      // Create image
      overlayImg = document.createElement('img');
      overlayImg.src = imageUrl;
      overlayImg.style.opacity = opacitySlider.value / 100;
      
      overlayImg.onload = () => {
        log('✅ Immagine caricata: ' + overlayImg.width + 'x' + overlayImg.height + 'px');
      };
      
      overlayImg.onerror = () => {
        log('❌ Errore caricamento immagine!', '#E65454');
      };
      
      overlayContainer.appendChild(overlayImg);
      
      // Add to map
      const mapDiv = document.getElementById('map');
      mapDiv.appendChild(overlayContainer);
      
      log('✅ Overlay aggiunto al DOM');
      
      // Reset position
      currentX = 0;
      currentY = 0;
      
      // Setup drag
      overlayContainer.addEventListener('mousedown', startDrag);
      log('✅ Event listener drag attaccato');
      
      updateTransform();
    }

    function startDrag(e) {
      log('👆 Drag iniziato!', '#FFD700');
      isDragging = true;
      dragStartX = e.clientX - currentX;
      dragStartY = e.clientY - currentY;
      e.preventDefault();
    }

    document.addEventListener('mousemove', (e) => {
      if (isDragging && overlayContainer) {
        currentX = e.clientX - dragStartX;
        currentY = e.clientY - dragStartY;
        updateTransform();
      }
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        log('👆 Drag completato! Pos: ' + currentX + ', ' + currentY, '#FFD700');
        isDragging = false;
      }
    });

    function updateTransform() {
      if (overlayContainer) {
        const scale = parseFloat(scaleSlider.value);
        const angle = parseInt(rotateSlider.value);
        
        overlayContainer.style.transform = 
          `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px)) scale(${scale}) rotate(${angle}deg)`;
      }
    }

    // Scale slider
    scaleSlider.addEventListener('input', (e) => {
      const scale = parseFloat(e.target.value);
      scaleValue.textContent = scale.toFixed(1) + 'x';
      updateTransform();
    });

    // Rotate slider
    rotateSlider.addEventListener('input', (e) => {
      const angle = parseInt(e.target.value);
      rotateValue.textContent = angle + '°';
      updateTransform();
    });

    // Opacity slider
    opacitySlider.addEventListener('input', (e) => {
      const opacity = parseInt(e.target.value);
      opacityValue.textContent = opacity + '%';
      if (overlayImg) {
        overlayImg.style.opacity = opacity / 100;
      }
    });

    // Reset button
    resetBtn.addEventListener('click', () => {
      log('🔄 Reset posizione');
      currentX = 0;
      currentY = 0;
      scaleSlider.value = 1;
      rotateSlider.value = 0;
      opacitySlider.value = 70;
      scaleValue.textContent = '1.0x';
      rotateValue.textContent = '0°';
      opacityValue.textContent = '70%';
      if (overlayImg) {
        overlayImg.style.opacity = 0.7;
      }
      updateTransform();
    });

    // Save button
    saveBtn.addEventListener('click', () => {
      if (!overlayContainer) {
        log('⚠️ Nessun overlay caricato!', '#FFA500');
        return;
      }

      log('💾 Calcolo coordinate geografiche...');
      
      const rect = overlayContainer.getBoundingClientRect();
      const scale = parseFloat(scaleSlider.value);
      
      // Calculate corners
      const width = overlayImg.offsetWidth * scale;
      const height = overlayImg.offsetHeight * scale;
      
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      
      const nw = map.containerPointToLatLng([centerX - width/2, centerY - height/2]);
      const ne = map.containerPointToLatLng([centerX + width/2, centerY - height/2]);
      const se = map.containerPointToLatLng([centerX + width/2, centerY + height/2]);
      const sw = map.containerPointToLatLng([centerX - width/2, centerY + height/2]);
      const center = map.containerPointToLatLng([centerX, centerY]);

      const georef = {
        corners: {
          nw: [nw.lat, nw.lng],
          ne: [ne.lat, ne.lng],
          se: [se.lat, se.lng],
          sw: [sw.lat, sw.lng]
        },
        center: [center.lat, center.lng],
        scale: scale,
        rotation: parseInt(rotateSlider.value),
        timestamp: new Date().toISOString()
      };

      // Download JSON
      const blob = new Blob([JSON.stringify(georef, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'overlay_georef.json';
      a.click();
      URL.revokeObjectURL(url);

      log('✅ Georeferenziazione salvata!', '#30c36b');
      log('📍 Centro: ' + center.lat.toFixed(6) + ', ' + center.lng.toFixed(6));
    });

    log('✅ Sistema pronto! Clicca "Carica Overlay"');
  </script>
</body>
</html>

