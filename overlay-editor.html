<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DMS ‚Ä¢ Overlay Editor - Georeferenziazione Pianta Mercato</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    :root{
      --bg:#072C2E; --panel:#0E2830; --ink:#D5F0E6; --accent:#0FA3A3; --good:#30c36b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    
    .topbar{position:sticky;top:0;z-index:1000;display:flex;justify-content:space-between;align-items:center;height:48px;padding:0 12px;background:#052023;border-bottom:1px solid #0b3b3f}
    .brand{font-weight:700;letter-spacing:.2px}
    .ver{opacity:.7;font-size:.9rem}
    
    #map{width:100%;height:calc(100vh - 48px);position:relative}
    
    .controls {
      position: fixed;
      top: 60px;
      right: 20px;
      background: #0E2830;
      padding: 20px;
      border-radius: 8px;
      z-index: 2000;
      width: 320px;
      max-height: calc(100vh - 80px);
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .controls h3 {
      margin: 0 0 15px;
      color: #D5F0E6;
    }
    
    button {
      background: var(--accent);
      border: none;
      color: #001b1c;
      padding: 12px;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin: 8px 0;
      transition: opacity 0.2s;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-save {
      background: var(--good) !important;
    }
    
    .control-group {
      margin: 15px 0;
    }
    
    label {
      display: block;
      margin: 10px 0 5px;
      color: #9AB8B3;
      font-size: 0.9rem;
    }
    
    .value-display {
      color: var(--accent);
      font-weight: 700;
    }
    
    input[type="range"] {
      width: 100%;
      margin: 10px 0;
    }
    
    .instructions {
      margin-top: 20px;
      padding: 12px;
      background: rgba(15, 163, 163, 0.1);
      border-radius: 6px;
      font-size: 0.85rem;
      color: #9AB8B3;
      line-height: 1.5;
    }
    
    .instructions strong {
      color: var(--accent);
    }
    
    /* Draggable overlay container */
    .overlay-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transform-origin: center center;
      cursor: move;
      z-index: 1500;
      pointer-events: auto;
    }
    
    .overlay-container img {
      display: block;
      width: 500px;
      user-select: none;
      -webkit-user-drag: none;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: #0f2830;
      padding: 30px;
      border-radius: 8px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    
    .modal-content h3 {
      margin: 0 0 20px;
      color: #0FA3A3;
    }
    
    .modal-content textarea {
      width: 100%;
      min-height: 400px;
      background: #1a3a44;
      color: #d5f0e6;
      border: 1px solid #0FA3A3;
      border-radius: 4px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      resize: vertical;
      margin-bottom: 15px;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .modal-buttons button {
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    
    .btn-copy {
      background: #FF9800;
      color: white;
    }
    
    .btn-download {
      background: #4CAF50;
      color: white;
    }
    
    .btn-close {
      background: #666;
      color: white;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">DMS ‚Ä¢ Overlay Editor - Georeferenziazione Pianta Mercato</div>
    <div class="ver">v1.0</div>
  </div>

  <div id="map"></div>

  <!-- Modal for JSON display -->
  <div id="jsonModal" class="modal">
    <div class="modal-content">
      <h3>üéØ JSON Completo Generato</h3>
      <textarea id="jsonTextarea" readonly></textarea>
      <div class="modal-buttons">
        <button id="copyBtn" class="btn-copy">üìã Copia negli Appunti</button>
        <button id="downloadBtn" class="btn-download">üíæ Scarica File</button>
        <button id="closeModalBtn" class="btn-close">‚ùå Chiudi</button>
      </div>
    </div>
  </div>

  <div class="controls">
    <h3>üé® Controlli Overlay</h3>
    
    <button id="loadBtn">üìÇ Carica Pianta Mercato</button>
    
    <div class="control-group">
      <label>üìè Scala: <span class="value-display" id="scaleValue">1.0x</span></label>
      <input type="range" id="scaleSlider" min="0.5" max="3" step="0.05" value="1">
    </div>
    
    <div class="control-group">
      <label>üîÑ Rotazione: <span class="value-display" id="rotateValue">0¬∞</span></label>
      <input type="range" id="rotateSlider" min="0" max="360" step="0.5" value="0">
    </div>
    
    <div class="control-group">
      <label>üëÅÔ∏è Opacit√†: <span class="value-display" id="opacityValue">70%</span></label>
      <input type="range" id="opacitySlider" min="0" max="100" step="5" value="70">
    </div>
    
    <button id="resetBtn">üîÑ Reset Posizione</button>
    <button id="saveBtn" class="btn-save">üíæ Salva Georeferenziazione</button>
    <button id="saveCompleteBtn" class="btn-save" style="background: #FF9800 !important;">üéØ Salva Completo (con Posteggi)</button>
    <div id="progressMsg" style="margin-top: 10px; font-size: 0.85rem; color: #0FA3A3;"></div>
    
    <div class="instructions">
      <strong>üìù Istruzioni:</strong><br>
      1. Clicca "Carica Pianta Mercato"<br>
      2. Trascina l'overlay sulla mappa<br>
      3. Usa gli slider per scalare/ruotare<br>
      4. Allinea con strade e piazze reali<br>
      5. Clicca "Salva" per esportare coordinate
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Initialize map centered on Grosseto market
    const map = L.map('map', {
      center: [42.758, 11.114],
      zoom: 16,
      zoomControl: true,
      maxZoom: 22
    });

    // Add OSM tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 22,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Load market area for reference
    fetch('data/grosseto_full.geojson')
      .then(r => r.json())
      .then(data => {
        const area = data.features.find(f => f.properties.kind === 'area');
        if (area) {
          L.geoJSON(area, {
            style: {
              color: '#2E7D32',
              fillColor: '#4CAF50',
              fillOpacity: 0.15,
              weight: 3
            }
          }).addTo(map);
        }
      })
      .catch(e => console.error('Error loading market area:', e));

    // Overlay state
    let overlayContainer = null;
    let overlayImg = null;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let currentX = 0;
    let currentY = 0;

    // Controls
    const loadBtn = document.getElementById('loadBtn');
    const scaleSlider = document.getElementById('scaleSlider');
    const rotateSlider = document.getElementById('rotateSlider');
    const opacitySlider = document.getElementById('opacitySlider');
    const resetBtn = document.getElementById('resetBtn');
    const saveBtn = document.getElementById('saveBtn');
    
    const scaleValue = document.getElementById('scaleValue');
    const rotateValue = document.getElementById('rotateValue');
    const opacityValue = document.getElementById('opacityValue');

    // Load overlay on button click
    loadBtn.addEventListener('click', () => {
      loadOverlay('data/grosseto_pianta_transparent.png');
    });

    function loadOverlay(imageUrl) {
      // Remove existing overlay
      if (overlayContainer) {
        overlayContainer.remove();
      }

      // Create container
      overlayContainer = document.createElement('div');
      overlayContainer.className = 'overlay-container';
      
      // Create image
      overlayImg = document.createElement('img');
      overlayImg.src = imageUrl;
      overlayImg.style.opacity = opacitySlider.value / 100;
      
      overlayImg.onerror = () => {
        alert('‚ö†Ô∏è Errore caricamento immagine!\nVerifica che il file esista in: ' + imageUrl);
      };
      
      overlayContainer.appendChild(overlayImg);
      
      // Add to map
      const mapDiv = document.getElementById('map');
      mapDiv.appendChild(overlayContainer);
      
      // Reset position
      currentX = 0;
      currentY = 0;
      
      // Setup drag
      overlayContainer.addEventListener('mousedown', startDrag);
      
      updateTransform();
      
      // Update button
      loadBtn.textContent = '‚úÖ Overlay Caricato';
      loadBtn.disabled = true;
    }

    function startDrag(e) {
      isDragging = true;
      dragStartX = e.clientX - currentX;
      dragStartY = e.clientY - currentY;
      overlayContainer.style.cursor = 'grabbing';
      e.preventDefault();
    }

    document.addEventListener('mousemove', (e) => {
      if (isDragging && overlayContainer) {
        currentX = e.clientX - dragStartX;
        currentY = e.clientY - dragStartY;
        updateTransform();
      }
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        if (overlayContainer) {
          overlayContainer.style.cursor = 'move';
        }
      }
    });

    function updateTransform() {
      if (overlayContainer) {
        const scale = parseFloat(scaleSlider.value);
        const angle = parseInt(rotateSlider.value);
        
        overlayContainer.style.transform = 
          `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px)) scale(${scale}) rotate(${angle}deg)`;
      }
    }

    // Scale slider
    scaleSlider.addEventListener('input', (e) => {
      const scale = parseFloat(e.target.value);
      scaleValue.textContent = scale.toFixed(1) + 'x';
      updateTransform();
    });

    // Rotate slider
    rotateSlider.addEventListener('input', (e) => {
      const angle = parseInt(e.target.value);
      rotateValue.textContent = angle + '¬∞';
      updateTransform();
    });

    // Opacity slider
    opacitySlider.addEventListener('input', (e) => {
      const opacity = parseInt(e.target.value);
      opacityValue.textContent = opacity + '%';
      if (overlayImg) {
        overlayImg.style.opacity = opacity / 100;
      }
    });

    // Reset button
    resetBtn.addEventListener('click', () => {
      currentX = 0;
      currentY = 0;
      scaleSlider.value = 1;
      rotateSlider.value = 0;
      opacitySlider.value = 70;
      scaleValue.textContent = '1.0x';
      rotateValue.textContent = '0¬∞';
      opacityValue.textContent = '70%';
      if (overlayImg) {
        overlayImg.style.opacity = 0.7;
      }
      updateTransform();
    });

    // Save button
    saveBtn.addEventListener('click', () => {
      if (!overlayContainer) {
        alert('‚ö†Ô∏è Nessun overlay caricato!\nClicca prima su "Carica Pianta Mercato"');
        return;
      }

      // Calculate geographic coordinates
      const rect = overlayContainer.getBoundingClientRect();
      const scale = parseFloat(scaleSlider.value);
      
      // Calculate corners
      const width = overlayImg.offsetWidth * scale;
      const height = overlayImg.offsetHeight * scale;
      
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      
      const nw = map.containerPointToLatLng([centerX - width/2, centerY - height/2]);
      const ne = map.containerPointToLatLng([centerX + width/2, centerY - height/2]);
      const se = map.containerPointToLatLng([centerX + width/2, centerY + height/2]);
      const sw = map.containerPointToLatLng([centerX - width/2, centerY + height/2]);
      const center = map.containerPointToLatLng([centerX, centerY]);

      const georef = {
        mercato: "Grosseto - Mercato Esperanto",
        timestamp: new Date().toISOString(),
        corners: {
          nw: [nw.lat, nw.lng],
          ne: [ne.lat, ne.lng],
          se: [se.lat, se.lng],
          sw: [sw.lat, sw.lng]
        },
        center: [center.lat, center.lng],
        transform: {
          scale: scale,
          rotation: parseInt(rotateSlider.value),
          translateX: currentX,
          translateY: currentY
        },
        image: {
          width: overlayImg.offsetWidth,
          height: overlayImg.offsetHeight,
          source: overlayImg.src
        }
      };

      // Download JSON
      const blob = new Blob([JSON.stringify(georef, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'grosseto_overlay_georef.json';
      a.click();
      URL.revokeObjectURL(url);

      alert('‚úÖ Georeferenziazione salvata!\n\nFile: grosseto_overlay_georef.json\n\nCentro: ' + 
            center.lat.toFixed(6) + ', ' + center.lng.toFixed(6));
    });

    // Save Complete button (with stalls extraction)
    document.getElementById('saveCompleteBtn').addEventListener('click', async () => {
      if (!overlayContainer) {
        alert('‚ö†Ô∏è Nessun overlay caricato!\nClicca prima su "Carica Pianta Mercato"');
        return;
      }

      const progressMsg = document.getElementById('progressMsg');
      progressMsg.textContent = 'üîç Estrazione posteggi in corso...';

      try {
        // Get georef data (same as save button)
        const rect = overlayContainer.getBoundingClientRect();
        const scale = parseFloat(scaleSlider.value);
        const width = overlayImg.offsetWidth * scale;
        const height = overlayImg.offsetHeight * scale;
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        const nw = map.containerPointToLatLng([centerX - width/2, centerY - height/2]);
        const ne = map.containerPointToLatLng([centerX + width/2, centerY - height/2]);
        const se = map.containerPointToLatLng([centerX + width/2, centerY + height/2]);
        const sw = map.containerPointToLatLng([centerX - width/2, centerY + height/2]);
        const center = map.containerPointToLatLng([centerX, centerY]);

        const georef = {
          mercato: "Grosseto - Mercato Esperanto",
          timestamp: new Date().toISOString(),
          corners: {
            nw: [nw.lat, nw.lng],
            ne: [ne.lat, ne.lng],
            se: [se.lat, se.lng],
            sw: [sw.lat, sw.lng]
          },
          center: [center.lat, center.lng],
          transform: {
            scale: scale,
            rotation: parseInt(rotateSlider.value),
            translateX: currentX,
            translateY: currentY
          },
          image: {
            width: overlayImg.offsetWidth,
            height: overlayImg.offsetHeight,
            source: overlayImg.src
          }
        };

        // Extract stalls from image
        progressMsg.textContent = 'üñºÔ∏è Analisi immagine...';
        const stalls = await extractStallsFromImage(overlayImg.src, georef);
        
        progressMsg.textContent = `‚úÖ Trovati ${stalls.length} posteggi!`;

        // Create complete JSON
        const completeData = {
          mercato: "Grosseto - Mercato Esperanto",
          timestamp: new Date().toISOString(),
          georef: georef,
          stalls: {
            total: stalls.length,
            items: stalls
          }
        };

        // Show modal with JSON
        const jsonStr = JSON.stringify(completeData, null, 2);
        document.getElementById('jsonTextarea').value = jsonStr;
        document.getElementById('jsonModal').classList.add('active');
        
        // Store data for download button
        window.currentJsonData = jsonStr;
        
        progressMsg.textContent = `‚úÖ Trovati ${stalls.length} posteggi!`;

      } catch (error) {
        progressMsg.textContent = '‚ùå Errore: ' + error.message;
        console.error('Errore estrazione posteggi:', error);
        alert('‚ùå Errore durante l\'estrazione dei posteggi!\n\n' + error.message);
      }
    });

    // Function to extract stalls from image using Canvas
    async function extractStallsFromImage(imageSrc, georef) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = () => {
          try {
            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            
            // Draw image
            ctx.drawImage(img, 0, 0);
            
            // Get image data
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Find green rectangles (simple algorithm)
            const stalls = [];
            const visited = new Set();
            const minArea = 30;
            const maxArea = 8000;
            
            // Scan image for green pixels
            for (let y = 0; y < canvas.height; y += 5) {
              for (let x = 0; x < canvas.width; x += 5) {
                const idx = (y * canvas.width + x) * 4;
                const r = data[idx];
                const g = data[idx + 1];
                const b = data[idx + 2];
                const a = data[idx + 3];
                
                // Check if green (HSV-like check in RGB)
                if (a > 200 && g > 100 && g > r && g > b && (g - r) > 30) {
                  const key = `${Math.floor(x/10)},${Math.floor(y/10)}`;
                  if (!visited.has(key)) {
                    visited.add(key);
                    
                    // Found a green area, add as stall
                    const stallId = stalls.length + 1;
                    
                    // Convert pixel to geo
                    const geoCoords = pixelToGeo(x, y, canvas.width, canvas.height, georef);
                    
                    stalls.push({
                      id: stallId,
                      center_px: [x, y],
                      lat: geoCoords[0],
                      lng: geoCoords[1]
                    });
                  }
                }
              }
            }
            
            resolve(stalls);
          } catch (error) {
            reject(error);
          }
        };
        
        img.onerror = () => reject(new Error('Impossibile caricare immagine'));
        img.src = imageSrc;
      });
    }

    // Convert pixel coordinates to geographic
    function pixelToGeo(px, py, imgWidth, imgHeight, georef) {
      // Scale from real image to editor scaled image
      const editorScaledWidth = georef.image.width * georef.transform.scale;
      const editorScaledHeight = georef.image.height * georef.transform.scale;
      
      const scaleX = editorScaledWidth / imgWidth;
      const scaleY = editorScaledHeight / imgHeight;
      
      const pxEditor = px * scaleX;
      const pyEditor = py * scaleY;
      
      // Normalize (0-1)
      const normX = pxEditor / editorScaledWidth;
      const normY = pyEditor / editorScaledHeight;
      
      // Interpolate between corners
      const nw = georef.corners.nw;
      const ne = georef.corners.ne;
      const sw = georef.corners.sw;
      const se = georef.corners.se;
      
      const topLat = nw[0] + (ne[0] - nw[0]) * normX;
      const topLng = nw[1] + (ne[1] - nw[1]) * normX;
      
      const bottomLat = sw[0] + (se[0] - sw[0]) * normX;
      const bottomLng = sw[1] + (se[1] - sw[1]) * normX;
      
      const lat = topLat + (bottomLat - topLat) * normY;
      const lng = topLng + (bottomLng - topLng) * normY;
      
      return [lat, lng];
    }

    // Modal buttons
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const textarea = document.getElementById('jsonTextarea');
      try {
        // Modern clipboard API
        await navigator.clipboard.writeText(textarea.value);
        alert('‚úÖ JSON copiato negli appunti!\n\nPuoi incollarlo dove vuoi (Notes, Files, ecc.)');
      } catch (err) {
        // Fallback for older browsers/iOS
        textarea.select();
        document.execCommand('copy');
        alert('‚úÖ JSON copiato negli appunti!\n\nPuoi incollarlo dove vuoi (Notes, Files, ecc.)');
      }
    });

    document.getElementById('downloadBtn').addEventListener('click', () => {
      const blob = new Blob([window.currentJsonData], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'grosseto_complete.json';
      a.click();
      URL.revokeObjectURL(url);
      alert('‚úÖ File scaricato!\n\ngrosseto_complete.json');
    });

    document.getElementById('closeModalBtn').addEventListener('click', () => {
      document.getElementById('jsonModal').classList.remove('active');
      document.getElementById('progressMsg').textContent = '';
    });

    // Close modal on background click
    document.getElementById('jsonModal').addEventListener('click', (e) => {
      if (e.target.id === 'jsonModal') {
        document.getElementById('jsonModal').classList.remove('active');
        document.getElementById('progressMsg').textContent = '';
      }
    });
  </script>
</body>
</html>

