<!doctype html>
<html>
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DMS ‚Ä¢ Stalls ‚Üí PNG trasparente</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font: 14px system-ui; background: #0b1c26; color: #eaf1f5; display: flex; height: 100vh; }
  
  /* Sidebar */
  .sidebar { width: 360px; background: #0f2330; padding: 20px; overflow-y: auto; border-right: 1px solid #1a3a4a; }
  .sidebar h2 { font-size: 18px; margin-bottom: 16px; color: #4fc3a0; }
  .sidebar label { display: block; margin-top: 12px; font-size: 13px; color: #b0c4d0; }
  .sidebar input[type=range] { width: 100%; margin-top: 4px; }
  .sidebar input[type=file] { width: 100%; padding: 8px; background: #1a3a4a; border: 1px solid #2a4a5a; border-radius: 6px; color: #eaf1f5; cursor: pointer; }
  .sidebar button { width: 100%; background: #1f8f5f; border: 0; color: #fff; padding: 12px; border-radius: 8px; cursor: pointer; margin-top: 16px; font-size: 14px; font-weight: 600; }
  .sidebar button:hover { background: #2aa070; }
  .sidebar button:disabled { background: #3a5a5a; cursor: not-allowed; }
  .value-display { float: right; color: #4fc3a0; font-weight: 600; }
  .checkbox-label { display: flex; align-items: center; gap: 8px; margin-top: 12px; }
  .checkbox-label input { width: auto; }
  
  /* Main canvas area */
  .canvas-area { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow: auto; }
  .canvas-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; flex: 1; }
  .canvas-wrapper { display: flex; flex-direction: column; background: #0f2330; border-radius: 12px; padding: 16px; min-height: 0; }
  .canvas-wrapper h3 { font-size: 14px; margin-bottom: 12px; color: #4fc3a0; }
  .canvas-wrapper canvas { width: 100%; height: 100%; object-fit: contain; background: #111; border: 1px solid #223; border-radius: 8px; }
  
  /* Responsive */
  @media (max-width: 900px) {
    body { flex-direction: column; }
    .sidebar { width: 100%; max-height: 50vh; }
    .canvas-container { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="sidebar">
  <h2>üé® PNG Trasparente</h2>
  <p style="font-size: 12px; opacity: 0.8; margin-bottom: 16px;">Rimuovi lo sfondo e mantieni solo i posteggi verdi</p>
  
  <label>Carica Immagine o PDF</label>
  <input id="file" type="file" accept="image/*,application/pdf"/>
  
  <label>Hue Min/Max <span class="value-display" id="hvals">70‚Äì160</span></label>
  <input id="hmin" type="range" min="0" max="360" value="70">
  <input id="hmax" type="range" min="0" max="360" value="160">
  
  <label>Saturation Min <span class="value-display" id="sval">25</span></label>
  <input id="smin" type="range" min="0" max="100" value="25">
  
  <label>Value Min <span class="value-display" id="vval">25</span></label>
  <input id="vmin" type="range" min="0" max="100" value="25">
  
  <label class="checkbox-label">
    <input type="checkbox" id="keepDigits" checked>
    <span>Mantieni numeri scuri</span>
  </label>
  
  <button id="download" disabled>üì• Scarica PNG Trasparente</button>
  <button id="sendToBus" disabled style="background: #2a7a9f;">‚û°Ô∏è Invia ad Allineatore</button>
  <p style="font-size: 11px; opacity: 0.6; margin-top: 8px;">Regola i parametri finch√© il risultato √® soddisfacente, poi scarica o invia all'Allineatore</p>
</div>

<div class="canvas-area">
  <div class="canvas-container">
    <div class="canvas-wrapper">
      <h3>üì∑ Originale</h3>
      <canvas id="src"></canvas>
    </div>
    <div class="canvas-wrapper">
      <h3>‚ú® Risultato (Trasparenza Applicata)</h3>
      <canvas id="dst"></canvas>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
<script src="../shared/dms-bus.js"></script>
<script>
const f=document.getElementById('file'), sC=document.getElementById('src'), dC=document.getElementById('dst');
const hmin=document.getElementById('hmin'), hmax=document.getElementById('hmax'), smin=document.getElementById('smin'), vmin=document.getElementById('vmin'), keepDigits=document.getElementById('keepDigits');
const hvals=document.getElementById('hvals'), sval=document.getElementById('sval'), vval=document.getElementById('vval');
const downloadBtn=document.getElementById('download');
let img=new Image();

f.onchange=async()=>{
  const file=f.files[0]; if(!file) return;
  downloadBtn.disabled=true;
  sendBtn.disabled=true;
  
  if(file.type==='application/pdf'){
    const buf=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    const page=await pdf.getPage(1);
    const v=page.getViewport({scale:2});
    const canvas=document.createElement('canvas');
    canvas.width=v.width; canvas.height=v.height;
    await page.render({canvasContext:canvas.getContext('2d'),viewport:v}).promise;
    img.onload=()=>{ draw(); downloadBtn.disabled=false; sendBtn.disabled=false; };
    img.src=canvas.toDataURL('image/png');
  } else {
    img.onload=()=>{ draw(); downloadBtn.disabled=false; sendBtn.disabled=false; };
    img.src=URL.createObjectURL(file);
  }
};

[hmin,hmax,smin,vmin,keepDigits].forEach(el=>el.oninput=draw);

downloadBtn.onclick=()=>{
  const a=document.createElement('a');
  a.href=dC.toDataURL('image/png');
  a.download='stalls_transparent.png';
  a.click();
};

const sendBtn=document.getElementById('sendToBus');
sendBtn.onclick=async()=>{
  try{
    dC.toBlob(async(blob)=>{
      await DMSBUS.putBlob('png_transparent', blob);
      await DMSBUS.putJSON('png_meta', {w:dC.width, h:dC.height});
      alert('‚úÖ PNG salvato nel bus! Apro Allineatore...');
      window.open('../tools/align_editor.html', '_blank');
    }, 'image/png');
  }catch(err){
    alert('‚ùå Errore: '+err.message);
  }
};

function draw(){
  if(!img.naturalWidth) return;
  const W=img.naturalWidth,H=img.naturalHeight;
  sC.width=W; sC.height=H; dC.width=W; dC.height=H;
  
  const sctx=sC.getContext('2d'); sctx.drawImage(img,0,0);
  const dctx=dC.getContext('2d'); dctx.drawImage(img,0,0);
  
  const imgData=dctx.getImageData(0,0,W,H); const d=imgData.data;
  const HMIN=+hmin.value,HMAX=+hmax.value,SMIN=+smin.value/100,VMIN=+vmin.value/100;
  
  hvals.textContent=`${HMIN}‚Äì${HMAX}`;
  sval.textContent=smin.value;
  vval.textContent=vmin.value;
  
  for(let i=0;i<d.length;i+=4){
    const hsv=rgb2hsv(d[i],d[i+1],d[i+2]);
    let keep=(hsv.h>=HMIN&&hsv.h<=HMAX&&hsv.s>=SMIN&&hsv.v>=VMIN);
    if(keepDigits.checked){
      const lum=0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2];
      if(lum<90) keep=true;
    }
    d[i+3]=keep?255:0;
  }
  
  dctx.putImageData(imgData,0,0);
}

function rgb2hsv(R,G,B){
  const r=R/255,g=G/255,b=B/255;
  const M=Math.max(r,g,b),m=Math.min(r,g,b),C=M-m;
  let H=0;
  if(C!==0){
    if(M===r) H=((g-b)/C)%6;
    else if(M===g) H=(b-r)/C+2;
    else H=(r-g)/C+4;
    H*=60;
    if(H<0) H+=360;
  }
  const V=M, S=M===0?0:C/M;
  return {h:H,s:S,v:V};
}
</script>
</body>
</html>

