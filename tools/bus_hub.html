<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>DMS ‚Ä¢ BUS HUB - Centro di Controllo Workflow</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    
    .topbar {
      background: #0f2830;
      color: #d5f0e6;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .brand { font-weight: 600; font-size: 16px; }
    .ver { font-size: 12px; opacity: 0.7; }
    
    .app { display: flex; height: calc(100vh - 48px); }
    
    .sidebar {
      width: 380px;
      background: #0f2830;
      color: #d5f0e6;
      overflow-y: auto;
      padding: 20px;
      border-right: 1px solid rgba(213, 240, 230, 0.1);
    }
    
    .main-content {
      flex: 1;
      background: #0b1c26;
      overflow-y: auto;
      padding: 20px;
    }
    
    .section {
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(213, 240, 230, 0.1);
    }
    .section:last-child { border-bottom: none; }
    
    h2 {
      color: #4CAF50;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    h3 {
      color: #4CAF50;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    button, .btn {
      background: #1a9e9e;
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      width: 100%;
      margin-bottom: 8px;
      transition: background 0.2s;
      text-decoration: none;
      display: block;
      text-align: center;
    }
    button:hover, .btn:hover { background: #158787; }
    button:active, .btn:active { background: #106d6d; }
    
    button.danger, .btn.danger {
      background: #d32f2f;
    }
    button.danger:hover, .btn.danger:hover { background: #b71c1c; }
    
    button.secondary, .btn.secondary {
      background: #455a64;
    }
    button.secondary:hover, .btn.secondary:hover { background: #37474f; }
    
    button.success, .btn.success {
      background: #4CAF50;
    }
    button.success:hover, .btn.success:hover { background: #388e3c; }
    
    .workflow-step {
      background: #1a4a5a;
      border-left: 4px solid #455a64;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 4px;
      transition: all 0.3s;
    }
    
    .workflow-step.completed {
      border-left-color: #4CAF50;
      background: #1a5a4a;
    }
    
    .workflow-step.in-progress {
      border-left-color: #ff9800;
      background: #5a4a1a;
    }
    
    .workflow-step.waiting {
      border-left-color: #455a64;
      opacity: 0.6;
    }
    
    .workflow-step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .workflow-step-title {
      font-weight: 600;
      font-size: 14px;
    }
    
    .workflow-step-status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 3px;
      background: rgba(0,0,0,0.3);
    }
    
    .workflow-step-desc {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    
    .bus-data-item {
      background: #1a4a5a;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .bus-data-key {
      font-weight: 600;
      color: #4fc3a0;
      margin-bottom: 4px;
    }
    
    .bus-data-info {
      font-size: 11px;
      opacity: 0.7;
      display: flex;
      justify-content: space-between;
    }
    
    .bus-data-empty {
      text-align: center;
      padding: 20px;
      opacity: 0.5;
      font-size: 13px;
    }
    
    .card {
      background: #0f2330;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .card h3 {
      margin-top: 0;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    
    .stat-card {
      background: #1a4a5a;
      padding: 16px;
      border-radius: 6px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #4CAF50;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .progress-bar {
      background: #1a4a5a;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 12px;
    }
    
    .progress-bar-fill {
      background: linear-gradient(90deg, #4CAF50, #1a9e9e);
      height: 100%;
      transition: width 0.5s ease;
    }
    
    #preview-map {
      width: 100%;
      height: 300px;
      border-radius: 8px;
      margin-top: 12px;
    }
    
    .btn-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .alert {
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .alert-info {
      background: rgba(33, 150, 243, 0.2);
      border-left: 4px solid #2196F3;
      color: #b3d9ff;
    }
    
    .alert-warning {
      background: rgba(255, 152, 0, 0.2);
      border-left: 4px solid #ff9800;
      color: #ffd699;
    }
    
    .alert-success {
      background: rgba(76, 175, 80, 0.2);
      border-left: 4px solid #4CAF50;
      color: #c8e6c9;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">DMS ‚Ä¢ GEMELLO DIGITALE ‚Äî BUS HUB (Centro di Controllo)</div>
    <div class="ver" id="ver">v1.0</div>
  </header>

  <div class="app">
    <aside class="sidebar">
      <div class="section">
        <h2>üè† Navigazione</h2>
        <a href="../index-grosseto.html" class="btn secondary">‚Üê Torna a DMS Gemello Esperanto</a>
      </div>

      <div class="section">
        <h2>üéØ Workflow Tools</h2>
        <a href="stalls_alpha_tool.html" class="btn" id="btn-png-tool">
          üé® PNG Transparent Tool
        </a>
        <a href="area_editor_v2.html" class="btn" id="btn-area-editor">
          üó∫Ô∏è Area Editor v2
        </a>
        <a href="slot_editor.html" class="btn" id="btn-slot-editor">
          üìç Slot Editor
        </a>
        <a href="result_viewer.html" class="btn" id="btn-result-viewer">
          üìä Result Viewer
        </a>
      </div>

      <div class="section">
        <h2>üîß Gestione Bus</h2>
        <button id="btn-refresh" class="secondary">üîÑ Aggiorna Stato</button>
        <button id="btn-export" class="secondary">üíæ Esporta Progetto</button>
        <button id="btn-import" class="secondary">üìÇ Importa Progetto</button>
        <button id="btn-clear-all" class="danger">üóëÔ∏è Pulisci Tutto</button>
      </div>

      <div class="section">
        <h2>üì¶ Dati nel Bus</h2>
        <div id="bus-data-list">
          <div class="bus-data-empty">Caricamento...</div>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div class="card">
        <h3>üìä Dashboard Workflow</h3>
        <div class="alert alert-info" id="workflow-alert">
          Benvenuto nel BUS HUB! Qui puoi monitorare lo stato del workflow e navigare tra i tool.
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="stat-progress">0%</div>
            <div class="stat-label">Completamento</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-steps">0/4</div>
            <div class="stat-label">Step Completati</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-data">0</div>
            <div class="stat-label">Dati nel Bus</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-size">0 KB</div>
            <div class="stat-label">Dimensione Totale</div>
          </div>
        </div>
        
        <div class="progress-bar">
          <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%"></div>
        </div>
      </div>

      <div class="card">
        <h3>üîÑ Stato Workflow</h3>
        
        <div class="workflow-step" id="step-png">
          <div class="workflow-step-header">
            <div class="workflow-step-title">1Ô∏è‚É£ PNG Transparent Tool</div>
            <div class="workflow-step-status" id="status-png">‚è∏Ô∏è In attesa</div>
          </div>
          <div class="workflow-step-desc">Rimuovi lo sfondo dalla pianta del mercato e salva PNG trasparente</div>
          <a href="stalls_alpha_tool.html" class="btn secondary" style="margin-top: 8px;">Vai al Tool ‚Üí</a>
        </div>

        <div class="workflow-step" id="step-area">
          <div class="workflow-step-header">
            <div class="workflow-step-title">2Ô∏è‚É£ Area Editor v2</div>
            <div class="workflow-step-status" id="status-area">‚è∏Ô∏è In attesa</div>
          </div>
          <div class="workflow-step-desc">Georeferenzia la pianta, disegna area mercato e area HUB</div>
          <a href="area_editor_v2.html" class="btn secondary" style="margin-top: 8px;">Vai al Tool ‚Üí</a>
        </div>

        <div class="workflow-step" id="step-slot">
          <div class="workflow-step-header">
            <div class="workflow-step-title">3Ô∏è‚É£ Slot Editor</div>
            <div class="workflow-step-status" id="status-slot">‚è∏Ô∏è In attesa</div>
          </div>
          <div class="workflow-step-desc">Digitalizza i posteggi del mercato</div>
          <a href="slot_editor.html" class="btn secondary" style="margin-top: 8px;">Vai al Tool ‚Üí</a>
        </div>

        <div class="workflow-step" id="step-result">
          <div class="workflow-step-header">
            <div class="workflow-step-title">4Ô∏è‚É£ Result Viewer</div>
            <div class="workflow-step-status" id="status-result">‚è∏Ô∏è In attesa</div>
          </div>
          <div class="workflow-step-desc">Visualizza e esporta il risultato finale</div>
          <a href="result_viewer.html" class="btn secondary" style="margin-top: 8px;">Vai al Tool ‚Üí</a>
        </div>
      </div>

      <div class="card">
        <h3>üó∫Ô∏è Preview Mappa</h3>
        <div id="preview-map"></div>
      </div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="js/dmsbus.js"></script>
  <script>
    // Inizializza mappa preview
    const previewMap = L.map('preview-map').setView([42.7633, 11.1117], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '¬© OpenStreetMap'
    }).addTo(previewMap);

    let overlayLayer = null;
    let areaLayer = null;
    let hubLayer = null;

    // Funzione per aggiornare lo stato del workflow
    async function updateWorkflowStatus() {
      try {
        // Leggi dati dal bus
        const pngTransparent = await DMSBUS.get('png_transparent');
        const pngMeta = await DMSBUS.getJSON('png_meta');
        const gcp = await DMSBUS.getJSON('gcp');
        const container = await DMSBUS.getJSON('container');
        const areaGeoJSON = await DMSBUS.getJSON('area_geojson');
        const hubGeoJSON = await DMSBUS.getJSON('hub_geojson');
        const stallsGeoJSON = await DMSBUS.getJSON('stalls_geojson');

        // Conta step completati
        let completedSteps = 0;
        let totalData = 0;
        let totalSize = 0;

        // Step 1: PNG Tool
        const step1 = document.getElementById('step-png');
        const status1 = document.getElementById('status-png');
        if (pngTransparent && pngMeta) {
          step1.classList.remove('waiting', 'in-progress');
          step1.classList.add('completed');
          status1.textContent = '‚úÖ Completato';
          completedSteps++;
          totalData += 2;
          totalSize += (pngTransparent?.length || 0) + JSON.stringify(pngMeta || {}).length;
        } else {
          step1.classList.remove('completed', 'in-progress');
          step1.classList.add('waiting');
          status1.textContent = '‚è∏Ô∏è In attesa';
        }

        // Step 2: Area Editor
        const step2 = document.getElementById('step-area');
        const status2 = document.getElementById('status-area');
        if (gcp && container) {
          step2.classList.remove('waiting', 'in-progress');
          step2.classList.add('completed');
          status2.textContent = '‚úÖ Completato';
          completedSteps++;
          totalData += 2;
          totalSize += JSON.stringify(gcp || {}).length + JSON.stringify(container || {}).length;
        } else if (pngTransparent && pngMeta) {
          step2.classList.remove('waiting', 'completed');
          step2.classList.add('in-progress');
          status2.textContent = '‚è≥ Pronto per iniziare';
        } else {
          step2.classList.remove('completed', 'in-progress');
          step2.classList.add('waiting');
          status2.textContent = '‚è∏Ô∏è In attesa';
        }

        // Aggiungi area e hub se presenti
        if (areaGeoJSON) {
          totalData++;
          totalSize += JSON.stringify(areaGeoJSON).length;
        }
        if (hubGeoJSON) {
          totalData++;
          totalSize += JSON.stringify(hubGeoJSON).length;
        }

        // Step 3: Slot Editor
        const step3 = document.getElementById('step-slot');
        const status3 = document.getElementById('status-slot');
        if (stallsGeoJSON) {
          step3.classList.remove('waiting', 'in-progress');
          step3.classList.add('completed');
          status3.textContent = '‚úÖ Completato';
          completedSteps++;
          totalData++;
          totalSize += JSON.stringify(stallsGeoJSON).length;
        } else if (gcp && container) {
          step3.classList.remove('waiting', 'completed');
          step3.classList.add('in-progress');
          status3.textContent = '‚è≥ Pronto per iniziare';
        } else {
          step3.classList.remove('completed', 'in-progress');
          step3.classList.add('waiting');
          status3.textContent = '‚è∏Ô∏è In attesa';
        }

        // Step 4: Result Viewer
        const step4 = document.getElementById('step-result');
        const status4 = document.getElementById('status-result');
        if (stallsGeoJSON && areaGeoJSON && gcp) {
          step4.classList.remove('waiting', 'in-progress');
          step4.classList.add('completed');
          status4.textContent = '‚úÖ Completato';
          completedSteps++;
        } else if (stallsGeoJSON || (gcp && container)) {
          step4.classList.remove('waiting', 'completed');
          step4.classList.add('in-progress');
          status4.textContent = '‚è≥ Pronto per iniziare';
        } else {
          step4.classList.remove('completed', 'in-progress');
          step4.classList.add('waiting');
          status4.textContent = '‚è∏Ô∏è In attesa';
        }

        // Aggiorna statistiche
        const progress = Math.round((completedSteps / 4) * 100);
        document.getElementById('stat-progress').textContent = progress + '%';
        document.getElementById('stat-steps').textContent = completedSteps + '/4';
        document.getElementById('stat-data').textContent = totalData;
        document.getElementById('stat-size').textContent = Math.round(totalSize / 1024) + ' KB';
        document.getElementById('progress-bar-fill').style.width = progress + '%';

        // Aggiorna alert
        const alert = document.getElementById('workflow-alert');
        if (completedSteps === 4) {
          alert.className = 'alert alert-success';
          alert.textContent = 'üéâ Workflow completato! Tutti i dati sono pronti.';
        } else if (completedSteps > 0) {
          alert.className = 'alert alert-info';
          alert.textContent = `‚ú® Workflow in corso... ${completedSteps} step su 4 completati.`;
        } else {
          alert.className = 'alert alert-warning';
          alert.textContent = '‚ö†Ô∏è Nessun dato nel bus. Inizia dal PNG Transparent Tool!';
        }

        // Aggiorna lista dati bus
        updateBusDataList();

        // Aggiorna preview mappa
        updateMapPreview(gcp, areaGeoJSON, hubGeoJSON, stallsGeoJSON);

      } catch (err) {
        console.error('Errore aggiornamento stato:', err);
      }
    }

    // Funzione per aggiornare lista dati nel bus
    async function updateBusDataList() {
      const container = document.getElementById('bus-data-list');
      container.innerHTML = '';

      const keys = ['png_transparent', 'png_meta', 'gcp', 'container', 'area_geojson', 'hub_geojson', 'stalls_geojson'];
      let hasData = false;

      for (const key of keys) {
        try {
          let data;
          if (key === 'png_transparent') {
            data = await DMSBUS.get(key);
          } else {
            data = await DMSBUS.getJSON(key);
          }

          if (data) {
            hasData = true;
            const item = document.createElement('div');
            item.className = 'bus-data-item';
            
            const keyDiv = document.createElement('div');
            keyDiv.className = 'bus-data-key';
            keyDiv.textContent = key;
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'bus-data-info';
            
            const size = key === 'png_transparent' 
              ? Math.round(data.length / 1024) + ' KB'
              : Math.round(JSON.stringify(data).length / 1024) + ' KB';
            
            infoDiv.innerHTML = `
              <span>‚úÖ Presente</span>
              <span>${size}</span>
            `;
            
            item.appendChild(keyDiv);
            item.appendChild(infoDiv);
            container.appendChild(item);
          }
        } catch (err) {
          // Dato non presente, skip
        }
      }

      if (!hasData) {
        container.innerHTML = '<div class="bus-data-empty">Nessun dato nel bus</div>';
      }
    }

    // Funzione per aggiornare preview mappa
    function updateMapPreview(gcp, areaGeoJSON, hubGeoJSON, stallsGeoJSON) {
      // Rimuovi layer esistenti
      if (overlayLayer) {
        previewMap.removeLayer(overlayLayer);
        overlayLayer = null;
      }
      if (areaLayer) {
        previewMap.removeLayer(areaLayer);
        areaLayer = null;
      }
      if (hubLayer) {
        previewMap.removeLayer(hubLayer);
        hubLayer = null;
      }

      // Aggiungi overlay se presente
      if (gcp && gcp.corners) {
        // TODO: Aggiungere overlay quando disponibile
      }

      // Aggiungi area mercato
      if (areaGeoJSON) {
        areaLayer = L.geoJSON(areaGeoJSON, {
          style: {
            color: '#4CAF50',
            weight: 2,
            fillOpacity: 0.2
          }
        }).addTo(previewMap);
        previewMap.fitBounds(areaLayer.getBounds());
      }

      // Aggiungi area HUB
      if (hubGeoJSON) {
        hubLayer = L.geoJSON(hubGeoJSON, {
          style: {
            color: '#ff9800',
            weight: 2,
            fillOpacity: 0.2
          }
        }).addTo(previewMap);
      }

      // Aggiungi posteggi
      if (stallsGeoJSON) {
        L.geoJSON(stallsGeoJSON, {
          style: {
            color: '#2196F3',
            weight: 1,
            fillOpacity: 0.3
          }
        }).addTo(previewMap);
      }
    }

    // Event listeners
    document.getElementById('btn-refresh').addEventListener('click', updateWorkflowStatus);

    document.getElementById('btn-clear-all').addEventListener('click', async () => {
      if (confirm('‚ö†Ô∏è Sei sicuro di voler cancellare TUTTI i dati dal bus?\n\nQuesta operazione non pu√≤ essere annullata!')) {
        try {
          const keys = ['png_transparent', 'png_meta', 'gcp', 'container', 'area_geojson', 'hub_geojson', 'stalls_geojson'];
          for (const key of keys) {
            await DMSBUS.delete(key);
          }
          alert('‚úÖ Bus pulito con successo!');
          updateWorkflowStatus();
        } catch (err) {
          alert('‚ùå Errore durante la pulizia del bus: ' + err.message);
        }
      }
    });

    document.getElementById('btn-export').addEventListener('click', async () => {
      try {
        const project = {};
        const keys = ['png_transparent', 'png_meta', 'gcp', 'container', 'area_geojson', 'hub_geojson', 'stalls_geojson'];
        
        for (const key of keys) {
          try {
            if (key === 'png_transparent') {
              project[key] = await DMSBUS.get(key);
            } else {
              project[key] = await DMSBUS.getJSON(key);
            }
          } catch (err) {
            // Skip missing keys
          }
        }

        const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dms-project-' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
        URL.revokeObjectURL(url);
        
        alert('‚úÖ Progetto esportato con successo!');
      } catch (err) {
        alert('‚ùå Errore durante l\'esportazione: ' + err.message);
      }
    });

    document.getElementById('btn-import').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = async (e) => {
        try {
          const file = e.target.files[0];
          const text = await file.text();
          const project = JSON.parse(text);

          for (const [key, value] of Object.entries(project)) {
            if (key === 'png_transparent') {
              await DMSBUS.put(key, value);
            } else {
              await DMSBUS.putJSON(key, value);
            }
          }

          alert('‚úÖ Progetto importato con successo!');
          updateWorkflowStatus();
        } catch (err) {
          alert('‚ùå Errore durante l\'importazione: ' + err.message);
        }
      };
      input.click();
    });

    // Aggiorna stato all'avvio
    updateWorkflowStatus();

    // Auto-refresh ogni 5 secondi
    setInterval(updateWorkflowStatus, 5000);
  </script>
</body>
</html>

