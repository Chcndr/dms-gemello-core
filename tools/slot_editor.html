<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DMS ‚Ä¢ Slot Editor</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="../shared/dms-console.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    
    .container { display: flex; height: calc(100vh - 48px); }
    
    .sidebar {
      width: 350px;
      background: #0f2830;
      color: #d5f0e6;
      padding: 1rem;
      overflow-y: auto;
    }
    
    .sidebar h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: #4CAF50; }
    .sidebar h2 { font-size: 1.1rem; margin: 1rem 0 0.5rem; color: #81C784; }
    
    .section { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #1a4a5a; }
    
    button {
      width: 100%;
      padding: 0.75rem;
      margin: 0.25rem 0;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    
    button:hover { background: #45a049; }
    button:disabled { background: #666; cursor: not-allowed; }
    button.secondary { background: #2196F3; }
    button.danger { background: #F44336; }
    button.active { background: #FF9800; }
    
    input[type="text"], input[type="number"], input[type="file"], select {
      width: 100%;
      padding: 0.5rem;
      margin: 0.25rem 0;
      background: #1a4a5a;
      color: #d5f0e6;
      border: 1px solid #2a5a6a;
      border-radius: 4px;
    }
    
    label { display: block; margin: 0.5rem 0 0.25rem; font-size: 0.9rem; }
    
    .info { 
      background: #1a4a5a; 
      padding: 0.75rem; 
      border-radius: 4px; 
      font-size: 0.85rem;
      margin: 0.5rem 0;
    }
    
    .slot-list {
      max-height: 300px;
      overflow-y: auto;
      background: #1a4a5a;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    
    .slot-item {
      padding: 0.25rem;
      margin: 0.25rem 0;
      background: #0f2830;
      border-radius: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .slot-item button {
      width: auto;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      margin: 0;
    }
    
    #map { flex: 1; }
    
    .leaflet-overlay-pane img {
      opacity: 0.6;
    }
    
    .slot-marker {
      background: rgba(76, 175, 80, 0.8);
      color: white;
      border: 2px solid white;
      padding: 4px 8px;
      font-weight: bold;
      font-size: 11px;
      text-align: center;
      white-space: nowrap;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .topbar {
      background: #0f2830;
      color: #d5f0e6;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .brand { font-weight: 600; font-size: 16px; }
    .ver { font-size: 12px; opacity: 0.7; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">DMS ‚Ä¢ GEMELLO DIGITALE ‚Äî Slot Editor</div>
    <div class="ver">v1.0</div>
  </header>
  <div class="container">
    <div class="sidebar">
      <h1>üéØ Slot Editor</h1>
      <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">
        Digitalizza posteggi da pianta PDF
      </p>

      <div class="section">
        <h2>üöå Carica dal Bus</h2>
        <button id="load-from-bus-btn" class="secondary">üöå Carica Dati dal Bus</button>
        <div class="info" id="bus-info">Carica automaticamente area e pianta dal workflow</div>
      </div>

      <div class="section">
        <h2>1. Carica Area Mercato</h2>
        <input type="file" id="area-file" accept=".geojson,.json">
        <div class="info" id="area-info">Nessuna area caricata</div>
      </div>

      <div class="section">
        <h2>2. Sovrapponi Pianta PDF</h2>
        <input type="file" id="pdf-file" accept=".pdf,.png,.jpg,.jpeg">
        <button id="align-btn" disabled>Posiziona Pianta</button>
        <button id="clear-plant-btn" class="danger" style="margin-top: 0.5rem;">üóëÔ∏è Pulisci Pianta</button>
        <div class="info" id="pdf-info">Nessuna pianta caricata</div>
      </div>

      <div class="section">
        <h2>3. Aggiungi Posteggi</h2>
        <label>Numero Posteggio</label>
        <input type="number" id="slot-number" min="1" max="999" value="1">
        
        <label>Rotazione: <span id="rotation-value">0</span>¬∞</label>
        <input type="range" id="slot-rotation" min="0" max="360" value="0" step="1" style="width:100%">
        
        <label>Larghezza: <span id="width-value">3.0</span>m</label>
        <input type="range" id="slot-width" min="1" max="20" value="3" step="0.1" style="width:100%">
        
        <label>Altezza: <span id="height-value">6.0</span>m</label>
        <input type="range" id="slot-height" min="1" max="20" value="6" step="0.1" style="width:100%">
        
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" id="keep-dimensions" checked>
          <span>Mantieni dimensioni per prossimi posteggi</span>
        </label>
        
        <button id="add-mode-btn">üìç Modalit√† Aggiungi Posteggio</button>
        <div class="info" id="mode-info">Clicca sul pulsante per iniziare</div>
      </div>

      <div class="section">
        <h2>4. Posteggi Aggiunti (<span id="slot-count">0</span>)</h2>
        <div class="slot-list" id="slot-list"></div>
        <button id="clear-btn" class="danger">üóëÔ∏è Cancella Tutti</button>
      </div>

      <div class="section">
        <h2>5. Esporta</h2>
        <button id="export-btn" class="secondary">üíæ Esporta GeoJSON</button>
        <button id="save-bus-btn" style="background:#2a7a9f">üíæ Salva nel Bus</button>
      </div>

      <div class="section">
        <a href="bus_hub.html" style="display: block; background: #1a9e9e; color: white; padding: 12px; border-radius: 4px; text-align: center; text-decoration: none; font-weight: 600;">üöå Vai al BUS HUB</a>
      </div>
    </div>

    <div id="map"></div>
  </div>
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script src="../shared/dms-bus.js"></script>
  <script src="../shared/dms-console.js"></script>
  <script>
    // Inizializza mappa con OpenStreetMap
    const map = L.map('map').setView([42.7639, 11.1139], 16);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    // State
    let areaLayer = null;
    let pdfOverlay = null;
    let slots = [];
    let addMode = false;
    let alignMode = false;
    let alignCorners = [];
    let container = null;
    let gcp = null;
    let pngMeta = null;

    // Elements
    const loadFromBusBtn = document.getElementById('load-from-bus-btn');
    const busInfo = document.getElementById('bus-info');
    const areaFile = document.getElementById('area-file');
    const pdfFile = document.getElementById('pdf-file');
    const alignBtn = document.getElementById('align-btn');
    const clearPlantBtn = document.getElementById('clear-plant-btn');
    const addModeBtn = document.getElementById('add-mode-btn');
    const slotNumber = document.getElementById('slot-number');
    const slotRotation = document.getElementById('slot-rotation');
    const slotWidth = document.getElementById('slot-width');
    const slotHeight = document.getElementById('slot-height');
    const rotationValue = document.getElementById('rotation-value');
    const widthValue = document.getElementById('width-value');
    const heightValue = document.getElementById('height-value');
    const keepDimensions = document.getElementById('keep-dimensions');
    const slotList = document.getElementById('slot-list');
    const slotCount = document.getElementById('slot-count');
    const clearBtn = document.getElementById('clear-btn');
    const exportBtn = document.getElementById('export-btn');
    const areaInfo = document.getElementById('area-info');
    const pdfInfo = document.getElementById('pdf-info');
    const modeInfo = document.getElementById('mode-info');
    
    // Funzione per ruotare immagine con canvas
    function rotateImage(imageUrl, rotation) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // Calcola dimensioni canvas ruotato
          const rad = (rotation * Math.PI) / 180;
          const cos = Math.abs(Math.cos(rad));
          const sin = Math.abs(Math.sin(rad));
          const newWidth = img.width * cos + img.height * sin;
          const newHeight = img.width * sin + img.height * cos;
          
          canvas.width = newWidth;
          canvas.height = newHeight;
          
          // Ruota e disegna
          ctx.translate(newWidth / 2, newHeight / 2);
          ctx.rotate(rad);
          ctx.drawImage(img, -img.width / 2, -img.height / 2);
          
          // Converti in blob
          canvas.toBlob((blob) => {
            resolve(URL.createObjectURL(blob));
          }, 'image/png');
        };
        img.src = imageUrl;
      });
    }

    // Auto-carica area e overlay dal bus
    async function loadFromBus() {
      try {
        // Carica area
        const areaGeoJSON = await DMSBUS.getJSON('area_geojson');
        if (areaGeoJSON) {
          if (areaLayer) map.removeLayer(areaLayer);
          
          areaLayer = L.geoJSON(areaGeoJSON, {
            style: { color: '#4CAF50', weight: 2, fillOpacity: 0.2 }
          }).addTo(map);
          
          areaInfo.textContent = `‚úÖ Area caricata dal bus (${ areaGeoJSON.features ? areaGeoJSON.features.length : 1} feature)`;
          console.log('‚úÖ Area caricata dal bus');
        }
        
        // Carica container e GCP
        container = await DMSBUS.getJSON('container');
        gcp = await DMSBUS.getJSON('gcp');
        pngMeta = await DMSBUS.getJSON('png_meta');
        
        if (container) {
          console.log('‚úÖ Container caricato dal bus');
        }
        
        // Carica overlay
        const blob = await DMSBUS.getBlob('png_transparent');
        
        if (blob && gcp) {
          // Crea URL da Blob
          let url = URL.createObjectURL(blob);
          
          // Leggi metadata per ottenere rotazione
          const rotation = pngMeta?.rotation || 0;
          
          // Se c'√® rotazione, ruota l'immagine prima
          if (rotation !== 0) {
            url = await rotateImage(url, -rotation);
            console.log('üîÑ Immagine ruotata per overlay:', -rotation + '¬∞');
          }
          
          // Calcola bounds geografici usando NW e SE corner (NON min/max!)
          const bounds = [
            [gcp.corners.nw[0], gcp.corners.nw[1]], // NW
            [gcp.corners.se[0], gcp.corners.se[1]]  // SE
          ];
          
          // Rimuovi overlay precedente
          if (pdfOverlay) {
            map.removeLayer(pdfOverlay);
          }
          
          // Crea overlay
          pdfOverlay = L.imageOverlay(url, bounds, {
            opacity: 0.6,
            interactive: false,
            zIndex: 400
          }).addTo(map);
          
          pdfInfo.textContent = '‚úÖ Pianta caricata dal bus (gi√† allineata)';
          console.log('‚úÖ Overlay caricato dal bus con rotazione:', -rotation + '¬∞');
        }
        
        // Centra sulla mappa
        if (areaLayer) {
          map.fitBounds(areaLayer.getBounds());
        } else if (pdfOverlay) {
          map.fitBounds(pdfOverlay.getBounds());
        }
        
      } catch (err) {
        console.log('‚ÑπÔ∏è Errore caricamento dal bus:', err.message);
      }
    }
    
    // Carica dal bus all'avvio
    loadFromBus();
    
    // Converti coordinate geografiche in pixel
    function latLngToPixel(latlng, gcp, pngMeta) {
      // Estrai bounds dai GCP
      const corners = gcp.corners;
      const latMin = Math.min(corners.nw[0], corners.ne[0], corners.se[0], corners.sw[0]);
      const latMax = Math.max(corners.nw[0], corners.ne[0], corners.se[0], corners.sw[0]);
      const lngMin = Math.min(corners.nw[1], corners.ne[1], corners.se[1], corners.sw[1]);
      const lngMax = Math.max(corners.nw[1], corners.ne[1], corners.se[1], corners.sw[1]);
      
      // Normalizza coordinate (0-1)
      const latNorm = (latlng.lat - latMin) / (latMax - latMin);
      const lngNorm = (latlng.lng - lngMin) / (lngMax - lngMin);
      
      // Converti in pixel (inverti latNorm perch√© le coordinate pixel crescono verso il basso)
      const x = lngNorm * pngMeta.w;
      const y = (1 - latNorm) * pngMeta.h;
      
      return [x, y];
    }

    // Load from bus
    loadFromBusBtn.addEventListener('click', async () => {
      try {
        busInfo.textContent = '‚è≥ Caricamento dal bus...';
        await loadFromBus();
        busInfo.textContent = '‚úÖ Dati caricati dal bus con successo!';
        pdfInfo.textContent = '‚úÖ Pianta caricata dal bus';
        alignBtn.disabled = true; // Disabilita align perch√© gi√† georeferenziata
      } catch (err) {
        busInfo.textContent = '‚ùå Errore: ' + err.message;
        console.error('Errore caricamento dal bus:', err);
      }
    });

    // Load area
    areaFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const text = await file.text();
      const geojson = JSON.parse(text);

      if (areaLayer) map.removeLayer(areaLayer);

      areaLayer = L.geoJSON(geojson, {
        style: { color: '#4CAF50', weight: 2, fillOpacity: 0.2 }
      }).addTo(map);

      map.fitBounds(areaLayer.getBounds());
      areaInfo.textContent = `‚úÖ Area caricata (${geojson.features.length} feature)`;
    });

    // Load PDF/image
    pdfFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        pdfInfo.textContent = `‚úÖ Pianta caricata: ${file.name}`;
        alignBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    });

    // Clear plant overlay
    clearPlantBtn.addEventListener('click', () => {
      if (pdfOverlay) {
        map.removeLayer(pdfOverlay);
        pdfOverlay = null;
        pdfInfo.textContent = '‚úÖ Pianta rimossa. Clicca "Carica Dati dal Bus" per ricaricare.';
        console.log('üóëÔ∏è Overlay pianta rimosso');
      } else {
        pdfInfo.textContent = '‚ö†Ô∏è Nessuna pianta da rimuovere';
      }
    });

    // Align PDF
    alignBtn.addEventListener('click', () => {
      alignMode = true;
      alignCorners = [];
      modeInfo.textContent = 'üìç Clicca sui 4 angoli della pianta sulla mappa (NW, NE, SE, SW)';
      alignBtn.classList.add('active');
    });

    // Slider event listeners
    slotRotation.addEventListener('input', (e) => {
      rotationValue.textContent = e.target.value;
    });
    
    slotWidth.addEventListener('input', (e) => {
      widthValue.textContent = parseFloat(e.target.value).toFixed(1);
    });
    
    slotHeight.addEventListener('input', (e) => {
      heightValue.textContent = parseFloat(e.target.value).toFixed(1);
    });

    // Add mode toggle
    addModeBtn.addEventListener('click', () => {
      addMode = !addMode;
      if (addMode) {
        addModeBtn.classList.add('active');
        addModeBtn.textContent = '‚è∏Ô∏è Ferma Modalit√† Aggiungi';
        modeInfo.textContent = '‚úÖ Clicca sulla mappa per aggiungere posteggi';
      } else {
        addModeBtn.classList.remove('active');
        addModeBtn.textContent = 'üìç Modalit√† Aggiungi Posteggio';
        modeInfo.textContent = 'Modalit√† disattivata';
      }
    });

    // Map click
    map.on('click', (e) => {
      if (alignMode) {
        handleAlignClick(e.latlng);
      } else if (addMode) {
        handleAddSlot(e.latlng);
      }
    });

    function handleAlignClick(latlng) {
      alignCorners.push(latlng);
      
      L.circleMarker(latlng, {
        radius: 8,
        color: '#FF9800',
        fillOpacity: 0.8
      }).addTo(map);

      if (alignCorners.length === 4) {
        // Create image overlay
        const bounds = L.latLngBounds(alignCorners);
        const file = pdfFile.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          if (pdfOverlay) map.removeLayer(pdfOverlay);
          pdfOverlay = L.imageOverlay(e.target.result, bounds, {
            opacity: 0.6,
            interactive: false
          }).addTo(map);
        };
        reader.readAsDataURL(file);

        alignMode = false;
        alignBtn.classList.remove('active');
        modeInfo.textContent = '‚úÖ Pianta posizionata! Ora puoi aggiungere posteggi';
      } else {
        modeInfo.textContent = `üìç Angolo ${alignCorners.length}/4 posizionato`;
      }
    }

    function handleAddSlot(latlng) {
      const number = parseInt(slotNumber.value);
      const angle = parseInt(slotRotation.value);
      const width = parseFloat(slotWidth.value);
      const height = parseFloat(slotHeight.value);

      // GeoJSON per visualizzazione
      const slot = {
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [latlng.lng, latlng.lat]
        },
        properties: {
          number: number,
          orientation: angle,
          kind: 'slot',
          status: 'free',
          dimensions: `${width}m √ó ${height}m`
        }
      };

      slots.push(slot);
      
      // Salva in container (coordinate pixel)
      if (container && gcp && pngMeta) {
        const pixelCoords = latLngToPixel(latlng, gcp, pngMeta);
        
        const stallPx = {
          id: number,
          center_px: pixelCoords,
          width_px: width,
          height_px: height,
          angle: angle,
          orientation: angle
        };
        
        container.stalls_px.push(stallPx);
        
        // Salva container aggiornato nel bus
        DMSBUS.putJSON('container', container).then(() => {
          console.log(`‚úÖ Posteggio ${number} salvato in container`);
        });
      }

      // Calcola dimensioni marker basate su larghezza/altezza
      const markerWidth = Math.max(20, width * 6);  // Scala per visualizzazione
      const markerHeight = Math.max(30, height * 6);
      
      // Add marker
      const marker = L.marker(latlng, {
        icon: L.divIcon({
          className: 'slot-marker',
          html: `<div style="transform: rotate(${angle}deg)">${number}</div>`,
          iconSize: [markerWidth, markerHeight],
          iconAnchor: [markerWidth/2, markerHeight/2]
        })
      }).addTo(map);

      marker.slotIndex = slots.length - 1;
      marker.on('click', () => {
        if (confirm(`Rimuovere posteggio ${number}?`)) {
          slots.splice(marker.slotIndex, 1);
          map.removeLayer(marker);
          updateSlotList();
        }
      });

      // Auto increment
      slotNumber.value = number + 1;
      
      // Se "Mantieni dimensioni" NON √® spuntata, resetta a valori default
      if (!keepDimensions.checked) {
        slotRotation.value = 0;
        slotWidth.value = 3;
        slotHeight.value = 6;
        rotationValue.textContent = '0';
        widthValue.textContent = '3.0';
        heightValue.textContent = '6.0';
      }

      updateSlotList();
    }

    function updateSlotList() {
      slotCount.textContent = slots.length;
      slotList.innerHTML = slots.map((s, i) => `
        <div class="slot-item">
          <span>Posteggio ${s.properties.number} (${s.properties.orientation}¬∞)</span>
          <button onclick="removeSlot(${i})">‚ùå</button>
        </div>
      `).join('');
    }

    window.removeSlot = (index) => {
      slots.splice(index, 1);
      updateSlotList();
      // Reload map to remove marker
      location.reload();
    };

    clearBtn.addEventListener('click', () => {
      if (confirm('Cancellare tutti i posteggi?')) {
        slots = [];
        updateSlotList();
        location.reload();
      }
    });

    exportBtn.addEventListener('click', () => {
      if (slots.length === 0) {
        alert('Nessun posteggio da esportare!');
        return;
      }

      // Merge area + slots
      let features = slots;
      if (areaLayer) {
        const areaGeoJSON = areaLayer.toGeoJSON();
        features = [...areaGeoJSON.features, ...slots];
      }

      const geojson = {
        type: 'FeatureCollection',
        features: features
      };

      const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `grosseto_${slots.length}_slots.geojson`;
      a.click();
    });
    
    // Salva nel bus
    const saveBusBtn = document.getElementById('save-bus-btn');
    saveBusBtn.addEventListener('click', async () => {
      if (slots.length === 0) {
        alert('Nessun posteggio da salvare!');
        return;
      }
      
      const geojson = {
        type: 'FeatureCollection',
        features: slots
      };
      
      try {
        await DMSBUS.putJSON('stalls_geojson', geojson);
        alert('‚úÖ Posteggi salvati nel bus!');
      } catch (err) {
        alert('‚ùå Errore: ' + err.message);
      }
    });
  </script>
</body>
</html>

