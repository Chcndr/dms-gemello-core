<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DMS ‚Ä¢ Slot Editor v2 (Standalone)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="../shared/dms-console.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    
    .container { display: flex; height: calc(100vh - 48px); }
    
    .sidebar {
      width: 380px;
      background: #0f2830;
      color: #d5f0e6;
      padding: 1rem;
      overflow-y: auto;
    }
    
    .sidebar h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: #4CAF50; }
    .sidebar h2 { font-size: 1.1rem; margin: 1rem 0 0.5rem; color: #81C784; }
    
    .section { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #1a4a5a; }
    
    button {
      width: 100%;
      padding: 0.75rem;
      margin: 0.25rem 0;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    
    button:hover { background: #45a049; }
    button:disabled { background: #666; cursor: not-allowed; }
    button.secondary { background: #2196F3; }
    button.danger { background: #F44336; }
    button.active { background: #FF9800; }
    
    input[type="text"], input[type="number"], input[type="file"], input[type="range"] {
      width: 100%;
      padding: 0.5rem;
      margin: 0.25rem 0;
      background: #1a4a5a;
      color: #d5f0e6;
      border: 1px solid #2a5a6a;
      border-radius: 4px;
    }
    
    input[type="range"] {
      padding: 0;
      height: 30px;
    }
    
    label { display: block; margin: 0.5rem 0 0.25rem; font-size: 0.9rem; }
    
    .slider-container {
      background: #1a4a5a;
      padding: 0.75rem;
      border-radius: 4px;
      margin: 0.5rem 0;
    }
    
    .slider-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    
    .info { 
      background: #1a4a5a; 
      padding: 0.75rem; 
      border-radius: 4px; 
      font-size: 0.85rem;
      margin: 0.5rem 0;
    }
    
    .slot-list {
      max-height: 200px;
      overflow-y: auto;
      background: #1a4a5a;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    
    .slot-item {
      padding: 0.25rem;
      margin: 0.25rem 0;
      background: #0f2830;
      border-radius: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .slot-item button {
      width: auto;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      margin: 0;
    }
    
    #map { flex: 1; position: relative; }
    
    .reference-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 400px;
      max-height: 500px;
      display: none;
    }
    
    .reference-panel.visible {
      display: block;
    }
    
    .reference-header {
      background: #4CAF50;
      color: white;
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
      font-weight: 600;
      font-size: 14px;
    }
    
    .reference-header button {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      width: 24px;
      height: 24px;
      margin: 0;
    }
    
    .reference-content {
      padding: 10px;
      overflow: auto;
      max-height: 450px;
    }
    
    .reference-content img {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .leaflet-overlay-pane img {
      opacity: 0.7;
    }
    
    .slot-marker {
      background: rgba(76, 175, 80, 0.8);
      color: white;
      border: 2px solid #4CAF50;
      border-radius: 3px;
      font-weight: bold;
      font-size: 11px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      cursor: pointer;
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }
    
    .checkbox-container input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <h1>üéØ Slot Editor v2</h1>
      <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">
        Editor standalone con controlli completi per pianta e posteggi
      </p>
      
      <!-- 0. Riferimento -->  
      <div class="section">
        <h2>0Ô∏è‚É£ Immagine Riferimento</h2>
        <button id="btn-toggle-reference" class="secondary">üëÅÔ∏è Mostra/Nascondi Originale</button>
        <div class="info">Mostra l'immagine originale con i numeri dei posteggi</div>
      </div>
      
      <!-- 1. Carica Pianta -->
      <div class="section">
        <h2>1Ô∏è‚É£ Carica Pianta</h2>
        <input type="file" id="png-file" accept="image/png" />
        <button id="btn-load-png" class="secondary">üìÇ Carica PNG Trasparente</button>
        <div class="info" id="png-status">Nessuna pianta caricata</div>
      </div>
      
      <!-- 2. Posiziona Pianta -->
      <div class="section">
        <h2>2Ô∏è‚É£ Posiziona Pianta</h2>
        
        <div class="slider-container">
          <div class="slider-label">
            <span>Rotazione pianta:</span>
            <span id="plant-rotation-value">0.0¬∞</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button id="btn-rotation-minus" class="secondary" style="width: 40px; padding: 8px;">‚àí</button>
            <input type="range" id="plant-rotation" min="0" max="360" value="0" step="0.1" style="flex: 1;" />
            <button id="btn-rotation-plus" class="secondary" style="width: 40px; padding: 8px;">+</button>
            <input type="number" id="plant-rotation-input" min="0" max="360" value="0" step="0.1" style="width: 80px; padding: 4px; text-align: center;" />
          </div>
        </div>
        
        <div class="slider-container">
          <div class="slider-label">
            <span>Scala pianta:</span>
            <span id="plant-scale-value">100.0%</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button id="btn-scale-minus" class="secondary" style="width: 40px; padding: 8px;">‚àí</button>
            <input type="range" id="plant-scale" min="1" max="500" value="100" step="0.1" style="flex: 1;" />
            <button id="btn-scale-plus" class="secondary" style="width: 40px; padding: 8px;">+</button>
            <input type="number" id="plant-scale-input" min="1" max="500" value="100" step="0.1" style="width: 80px; padding: 4px; text-align: center;" />
          </div>
        </div>
        
        <div class="slider-container">
          <div class="slider-label">
            <span>Opacit√† pianta:</span>
            <span id="plant-opacity-value">70%</span>
          </div>
          <input type="range" id="plant-opacity" min="0" max="100" value="70" step="5" />
        </div>
        
        <button id="btn-center-plant" class="secondary">üéØ Centra Pianta sulla Mappa</button>
        <div class="info">Trascina la pianta per posizionarla</div>
      </div>
      
      <!-- 3. Configura Posteggi -->
      <div class="section">
        <h2>3Ô∏è‚É£ Configura Posteggi</h2>
        
        <div class="slider-container">
          <div class="slider-label">
            <span>Larghezza (m):</span>
            <span id="slot-width-value">3.0m</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button id="btn-width-minus" class="secondary" style="padding: 4px 12px;">‚àí</button>
            <input type="range" id="slot-width" min="1" max="10" value="3" step="0.1" style="flex: 1;" />
            <button id="btn-width-plus" class="secondary" style="padding: 4px 12px;">+</button>
            <input type="number" id="slot-width-input" value="3.0" min="1" max="10" step="0.1" style="width: 60px;" />
          </div>
        </div>
        
        <div class="slider-container">
          <div class="slider-label">
            <span>Altezza (m):</span>
            <span id="slot-height-value">6.0m</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button id="btn-height-minus" class="secondary" style="padding: 4px 12px;">‚àí</button>
            <input type="range" id="slot-height" min="1" max="20" value="6" step="0.1" style="flex: 1;" />
            <button id="btn-height-plus" class="secondary" style="padding: 4px 12px;">+</button>
            <input type="number" id="slot-height-input" value="6.0" min="1" max="20" step="0.1" style="width: 60px;" />
          </div>
        </div>
        
        <div class="slider-container">
          <div class="slider-label">
            <span>Rotazione:</span>
            <span id="slot-rotation-value">0.0¬∞</span>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button id="btn-rotation-minus" class="secondary" style="padding: 4px 12px;">‚àí</button>
            <input type="range" id="slot-rotation" min="0" max="360" value="0" step="0.1" style="flex: 1;" />
            <button id="btn-rotation-plus" class="secondary" style="padding: 4px 12px;">+</button>
            <input type="number" id="slot-rotation-input" value="0.0" min="0" max="360" step="0.1" style="width: 60px;" />
          </div>
        </div>
        
        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
          <label style="margin: 0;">Numero:</label>
          <input type="number" id="slot-number" value="1" min="1" step="1" style="width: 80px;" />
        </div>
        
        <div class="checkbox-container">
          <input type="checkbox" id="keep-dimensions" checked />
          <label for="keep-dimensions" style="margin: 0;">Mantieni dimensioni fisse</label>
        </div>
        
        <button id="btn-add-mode" class="active">üìç Modalit√† Aggiungi Posteggio</button>
        <div class="info" id="slot-count">0 posteggi aggiunti</div>
      </div>
      
      <!-- 4. Lista Posteggi -->
      <div class="section">
        <h2>4Ô∏è‚É£ Posteggi Aggiunti (<span id="total-slots">0</span>)</h2>
        <div class="slot-list" id="slot-list">
          <div style="opacity: 0.6;">Nessun posteggio</div>
        </div>
        <button id="btn-clear-all" class="danger">üóëÔ∏è Cancella Tutti</button>
      </div>
      
      <!-- 5. Esporta -->
      <div class="section">
        <h2>5Ô∏è‚É£ Esporta</h2>
        <button id="btn-export-json" class="secondary">üíæ Esporta GeoJSON</button>
        <button id="btn-save-bus">üöå Salva nel Bus</button>
        <div class="info" id="export-status">Pronto per esportare</div>
      </div>
    </aside>
    
    <div id="map">
    <div id="reference-panel" class="reference-panel">
      <div class="reference-header" id="reference-header">
        <span>üì∑ Immagine Originale</span>
        <button id="btn-close-reference">‚úï</button>
      </div>
      <div class="reference-content" id="reference-content">
        <img id="reference-image" src="" alt="Immagine originale" style="transform-origin: center center; cursor: move;" />
      </div>
      <div class="reference-controls" style="padding: 8px; background: #f5f5f5; border-top: 1px solid #ddd;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
          <span style="font-size: 12px; min-width: 50px;">Zoom:</span>
          <button id="btn-ref-zoom-out" style="padding: 4px 8px; font-size: 14px;">‚àí</button>
          <input type="range" id="ref-zoom" min="50" max="300" value="100" step="10" style="flex: 1;" />
          <button id="btn-ref-zoom-in" style="padding: 4px 8px; font-size: 14px;">+</button>
          <span id="ref-zoom-value" style="font-size: 12px; min-width: 45px;">100%</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
          <span style="font-size: 12px; min-width: 50px;">Ruota:</span>
          <button id="btn-ref-rotate-left" style="padding: 4px 8px; font-size: 14px;">‚Ü∂</button>
          <input type="range" id="ref-rotation" min="0" max="360" value="0" step="1" style="flex: 1;" />
          <button id="btn-ref-rotate-right" style="padding: 4px 8px; font-size: 14px;">‚Ü∑</button>
          <span id="ref-rotation-value" style="font-size: 12px; min-width: 35px;">0¬∞</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
          <span style="font-size: 12px; min-width: 50px;">Sposta:</span>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; flex: 1;">
            <div></div>
            <button id="btn-ref-up" style="padding: 4px; font-size: 14px;">‚¨ÜÔ∏è</button>
            <div></div>
            <button id="btn-ref-left" style="padding: 4px; font-size: 14px;">‚¨ÖÔ∏è</button>
            <button id="btn-ref-center" style="padding: 4px; font-size: 10px;">üéØ</button>
            <button id="btn-ref-right" style="padding: 4px; font-size: 14px;">‚û°Ô∏è</button>
            <div></div>
            <button id="btn-ref-down" style="padding: 4px; font-size: 14px;">‚¨áÔ∏è</button>
            <div></div>
          </div>
        </div>
        <button id="btn-ref-reset" style="width: 100%; margin-top: 4px; padding: 4px; font-size: 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ Reset</button>
      </div>
    </div>
  </div>
  </div>
  
  <div id="dms-console"></div>
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="../shared/dms-bus.js"></script>
  <script src="../shared/dms-console.js"></script>
  <script>
    // Inizializza console
    DMSConsole.init();
    DMSConsole.log('üöÄ Slot Editor v2 inizializzato');
    
    // NOTA: Caricamento automatico dal BUS spostato dopo inizializzazione variabili (vedi sotto)
    
    // Inizializza mappa su Grosseto
    const map = L.map('map').setView([42.7589, 11.1135], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 20
    }).addTo(map);
    
    // Variabili globali
    let pdfBlob = null;
    let pdfBlobOriginal = null; // Blob originale non ruotato
    let pdfOverlay = null;
    let plantBounds = null;
    let plantRotation = 0;
    let plantScale = 1.0;
    let slotRotation = 0;
    let slots = [];
    let addMode = false;
    let slotCounter = 1;
    let plantMarker = null; // Marker per trascinare pianta
    let plantImageSize = { width: 500, height: 400 }; // Dimensioni immagine corrente
    
    // Carica automaticamente PNG dal BUS
    (async () => {
      try {
        DMSConsole.log('üîç Cerco PNG nel BUS...');
        
        // Carica PNG trasparente
        const blobTransparent = await DMSBUS.getBlob('png_transparent');
        if (blobTransparent) {
          pdfBlob = blobTransparent;
          pdfBlobOriginal = blobTransparent; // Salva originale per rotazioni
          
          // Carica immagine per ottenere dimensioni reali
          const img = new Image();
          img.src = URL.createObjectURL(blobTransparent);
          img.onload = () => {
            plantImageSize = { width: img.width, height: img.height };
            DMSConsole.log('‚úÖ Dimensioni immagine: ' + img.width + 'x' + img.height);
            URL.revokeObjectURL(img.src);
          };
          
          const center = map.getCenter();
          plantBounds = L.latLngBounds([
            [center.lat + 0.002, center.lng - 0.002],
            [center.lat - 0.002, center.lng + 0.002]
          ]);
          updatePlantOverlay();
          document.getElementById('png-status').textContent = '‚úÖ PNG trasparente caricato dal BUS';
          DMSConsole.log('‚úÖ PNG trasparente caricato dal BUS');
        } else {
          DMSConsole.log('‚ö†Ô∏è png_transparent non trovato nel BUS');
        }
        
        // Carica PNG originale
        const blobOriginal = await DMSBUS.getBlob('png_original');
        if (blobOriginal) {
          const url = URL.createObjectURL(blobOriginal);
          document.getElementById('reference-image').src = url;
          DMSConsole.log('‚úÖ PNG originale caricato dal BUS');
        } else {
          DMSConsole.log('‚ö†Ô∏è png_original non trovato nel BUS');
        }
      } catch (err) {
        DMSConsole.log('‚ùå Errore caricamento BUS: ' + err.message);
      }
    })();
    
    // Funzione per calcolare bounds ruotati e scalati
    function calculatePlantBounds(center, width, height, rotation, scale) {
      const scaledWidth = width * scale;
      const scaledHeight = height * scale;
      
      // Calcola offset in metri
      const latOffset = (scaledHeight / 2) / 111320; // 1 grado lat ‚âà 111.32 km
      const lngOffset = (scaledWidth / 2) / (111320 * Math.cos(center.lat * Math.PI / 180));
      
      // Corner base (senza rotazione)
      const corners = [
        [center.lat + latOffset, center.lng - lngOffset], // top-left
        [center.lat + latOffset, center.lng + lngOffset], // top-right
        [center.lat - latOffset, center.lng + lngOffset], // bottom-right
        [center.lat - latOffset, center.lng - lngOffset]  // bottom-left
      ];
      
      // Applica rotazione
      if (rotation !== 0) {
        const rad = rotation * Math.PI / 180;
        const cos = Math.cos(rad);
        const sin = Math.sin(rad);
        
        return corners.map(([lat, lng]) => {
          const dLat = lat - center.lat;
          const dLng = lng - center.lng;
          return [
            center.lat + (dLat * cos - dLng * sin),
            center.lng + (dLat * sin + dLng * cos)
          ];
        });
      }
      
      return corners;
    }
    
    // Funzione per aggiornare overlay pianta
    let isUpdatingPlant = false; // Flag per evitare loop
    function updatePlantOverlay() {
      if (!pdfBlob || !plantBounds || isUpdatingPlant) return;
      isUpdatingPlant = true;
      
      const center = plantMarker ? plantMarker.getLatLng() : map.getCenter();
      // NON ruotiamo le coordinate, solo scaliamo con dimensioni corrette
      const corners = calculatePlantBounds(center, plantImageSize.width, plantImageSize.height, 0, plantScale);
      const bounds = L.latLngBounds([corners[0], corners[2]]);
      
      if (pdfOverlay) {
        map.removeLayer(pdfOverlay);
      }
      
      const url = URL.createObjectURL(pdfBlob);
      pdfOverlay = L.imageOverlay(url, bounds, {
        opacity: parseFloat(document.getElementById('plant-opacity').value) / 100,
        interactive: false,
        zIndex: 400
      }).addTo(map);
      
      // Aggiungi/aggiorna marker trascinabile
      if (!plantMarker) {
        const redIcon = L.divIcon({
          className: 'plant-marker',
          html: '<div style="background: red; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); cursor: move;">M</div>',
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        });
        
        plantMarker = L.marker(center, { 
          icon: redIcon,
          draggable: true,
          zIndexOffset: 1000
        }).addTo(map);
        
        // Usa dragend invece di drag per evitare troppi aggiornamenti
        plantMarker.on('drag', () => {
          if (pdfOverlay && !isUpdatingPlant) {
            const newCenter = plantMarker.getLatLng();
            const corners = calculatePlantBounds(newCenter, plantImageSize.width, plantImageSize.height, 0, plantScale);
            const newBounds = L.latLngBounds([corners[0], corners[2]]);
            pdfOverlay.setBounds(newBounds);
          }
        });
        
        plantMarker.on('dragend', () => {
          DMSConsole.log('‚úÖ Pianta riposizionata');
        });
        
        DMSConsole.log('‚úÖ Marker pianta aggiunto - trascina per posizionare');
      } else {
        plantMarker.setLatLng(center);
      }
      
      plantBounds = bounds;
      isUpdatingPlant = false;
      DMSConsole.log('‚úÖ Pianta aggiornata');
    }
    
    // Toggle pannello riferimento
    document.getElementById('btn-toggle-reference').addEventListener('click', () => {
      const panel = document.getElementById('reference-panel');
      panel.classList.toggle('visible');
    });
    
    // Chiudi pannello riferimento
    document.getElementById('btn-close-reference').addEventListener('click', () => {
      document.getElementById('reference-panel').classList.remove('visible');
    });
    
    // Rendi pannello riferimento draggable
    const refPanel = document.getElementById('reference-panel');
    const refHeader = document.getElementById('reference-header');
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;
    
    refHeader.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);
    
    function dragStart(e) {
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;
      if (e.target === refHeader || refHeader.contains(e.target)) {
        isDragging = true;
      }
    }
    
    function drag(e) {
      if (isDragging) {
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        xOffset = currentX;
        yOffset = currentY;
        setTranslate(currentX, currentY, refPanel);
      }
    }
    
    function dragEnd(e) {
      initialX = currentX;
      initialY = currentY;
      isDragging = false;
    }
    
    function setTranslate(xPos, yPos, el) {
      el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
    }
    
    // Controlli immagine riferimento
    let refZoom = 100;
    let refRotation = 0;
    let refPanX = 0;
    let refPanY = 0;
    
    function updateReferenceImage() {
      const img = document.getElementById('reference-image');
      img.style.transform = `scale(${refZoom / 100}) rotate(${refRotation}deg) translate(${refPanX}px, ${refPanY}px)`;
    }
    
    // Zoom slider
    document.getElementById('ref-zoom').addEventListener('input', (e) => {
      refZoom = parseInt(e.target.value);
      document.getElementById('ref-zoom-value').textContent = refZoom + '%';
      updateReferenceImage();
    });
    
    // Zoom pulsanti
    document.getElementById('btn-ref-zoom-in').addEventListener('click', () => {
      refZoom = Math.min(300, refZoom + 10);
      document.getElementById('ref-zoom').value = refZoom;
      document.getElementById('ref-zoom-value').textContent = refZoom + '%';
      updateReferenceImage();
    });
    
    document.getElementById('btn-ref-zoom-out').addEventListener('click', () => {
      refZoom = Math.max(50, refZoom - 10);
      document.getElementById('ref-zoom').value = refZoom;
      document.getElementById('ref-zoom-value').textContent = refZoom + '%';
      updateReferenceImage();
    });
    
    // Rotazione slider
    document.getElementById('ref-rotation').addEventListener('input', (e) => {
      refRotation = parseInt(e.target.value);
      document.getElementById('ref-rotation-value').textContent = refRotation + '¬∞';
      updateReferenceImage();
    });
    
    // Rotazione pulsanti
    document.getElementById('btn-ref-rotate-left').addEventListener('click', () => {
      refRotation = (refRotation - 15 + 360) % 360;
      document.getElementById('ref-rotation').value = refRotation;
      document.getElementById('ref-rotation-value').textContent = refRotation + '¬∞';
      updateReferenceImage();
    });
    
    document.getElementById('btn-ref-rotate-right').addEventListener('click', () => {
      refRotation = (refRotation + 15) % 360;
      document.getElementById('ref-rotation').value = refRotation;
      document.getElementById('ref-rotation-value').textContent = refRotation + '¬∞';
      updateReferenceImage();
    });
    
    // Reset
    document.getElementById('btn-ref-reset').addEventListener('click', () => {
      refZoom = 100;
      refRotation = 0;
      refPanX = 0;
      refPanY = 0;
      document.getElementById('ref-zoom').value = 100;
      document.getElementById('ref-zoom-value').textContent = '100%';
      document.getElementById('ref-rotation').value = 0;
      document.getElementById('ref-rotation-value').textContent = '0¬∞';
      updateReferenceImage();
    });
    
    // Pulsanti freccia per spostare immagine
    const panStep = 20; // pixel per click
    
    document.getElementById('btn-ref-up').addEventListener('click', () => {
      refPanY += panStep;
      updateReferenceImage();
    });
    
    document.getElementById('btn-ref-down').addEventListener('click', () => {
      refPanY -= panStep;
      updateReferenceImage();
    });
    
    document.getElementById('btn-ref-left').addEventListener('click', () => {
      refPanX += panStep;
      updateReferenceImage();
    });
    
    document.getElementById('btn-ref-right').addEventListener('click', () => {
      refPanX -= panStep;
      updateReferenceImage();
    });
    
    document.getElementById('btn-ref-center').addEventListener('click', () => {
      refPanX = 0;
      refPanY = 0;
      updateReferenceImage();
    });
    
    // Pan immagine con drag (FIXATO: direzione corretta)
    const refContent = document.getElementById('reference-content');
    const refImage = document.getElementById('reference-image');
    let isImageDragging = false;
    let imageStartX, imageStartY, imagePanStartX, imagePanStartY;
    
    refImage.addEventListener('mousedown', (e) => {
      isImageDragging = true;
      imageStartX = e.clientX;
      imageStartY = e.clientY;
      imagePanStartX = refPanX;
      imagePanStartY = refPanY;
      e.preventDefault();
    });
    
    document.addEventListener('mousemove', (e) => {
      if (isImageDragging) {
        const deltaX = e.clientX - imageStartX;
        const deltaY = e.clientY - imageStartY;
        refPanX = imagePanStartX + deltaX;
        refPanY = imagePanStartY + deltaY;
        updateReferenceImage();
      }
    });
    
    document.addEventListener('mouseup', () => {
      isImageDragging = false;
    });
    
    // Zoom con rotella mouse
    refContent.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -10 : 10;
      refZoom = Math.max(50, Math.min(300, refZoom + delta));
      document.getElementById('ref-zoom').value = refZoom;
      document.getElementById('ref-zoom-value').textContent = refZoom + '%';
      updateReferenceImage();
    });

    
    // Carica PNG
    document.getElementById('btn-load-png').addEventListener('click', () => {
      const file = document.getElementById('png-file').files[0];
      if (!file) {
        alert('‚ö†Ô∏è Seleziona un file PNG prima!');
        return;
      }
      
      pdfBlob = file;
      pdfBlobOriginal = file; // Salva originale per rotazioni
      
      // Carica immagine per ottenere dimensioni reali
      const img = new Image();
      img.src = URL.createObjectURL(file);
      img.onload = () => {
        plantImageSize = { width: img.width, height: img.height };
        DMSConsole.log('‚úÖ Dimensioni immagine: ' + img.width + 'x' + img.height);
        URL.revokeObjectURL(img.src);
        
        const center = map.getCenter();
        plantBounds = L.latLngBounds([
          [center.lat + 0.002, center.lng - 0.002],
          [center.lat - 0.002, center.lng + 0.002]
        ]);
        
        updatePlantOverlay();
        document.getElementById('png-status').textContent = `‚úÖ ${file.name} caricato`;
        DMSConsole.log(`‚úÖ PNG caricato: ${file.name}`);
      };
    });
    
    // Funzione per aggiornare rotazione
    async function updateRotation(value) {
      plantRotation = parseFloat(value);
      document.getElementById('plant-rotation-value').textContent = plantRotation.toFixed(1) + '¬∞';
      document.getElementById('plant-rotation').value = plantRotation;
      document.getElementById('plant-rotation-input').value = plantRotation;
      
      if (!pdfBlobOriginal) return;
      
      // Ruota fisicamente l'immagine con canvas
      const img = new Image();
      const url = URL.createObjectURL(pdfBlobOriginal);
      img.src = url;
      
      img.onload = async () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Calcola dimensioni canvas ruotato
        const rad = plantRotation * Math.PI / 180;
        const cos = Math.abs(Math.cos(rad));
        const sin = Math.abs(Math.sin(rad));
        canvas.width = img.width * cos + img.height * sin;
        canvas.height = img.width * sin + img.height * cos;
        
        // Ruota e disegna
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(rad);
        ctx.drawImage(img, -img.width / 2, -img.height / 2);
        
        // Crea nuovo Blob
        pdfBlob = await new Promise(resolve => {
          canvas.toBlob(blob => resolve(blob), 'image/png');
        });
        
        // Aggiorna dimensioni immagine
        plantImageSize = { width: canvas.width, height: canvas.height };
        
        URL.revokeObjectURL(url);
        updatePlantOverlay();
        DMSConsole.log('‚úÖ Immagine ruotata fisicamente: ' + plantRotation.toFixed(1) + '¬∞ (dim: ' + canvas.width + 'x' + canvas.height + ')');
      };
    }
    
    // Slider rotazione pianta
    document.getElementById('plant-rotation').addEventListener('input', (e) => {
      updateRotation(e.target.value);
    });
    
    // Input numerico rotazione
    document.getElementById('plant-rotation-input').addEventListener('input', (e) => {
      updateRotation(e.target.value);
    });
    
    // Pulsanti +/- rotazione (0.1¬∞ alla volta)
    document.getElementById('btn-rotation-minus').addEventListener('click', () => {
      updateRotation(Math.max(0, plantRotation - 0.1));
    });
    
    document.getElementById('btn-rotation-plus').addEventListener('click', () => {
      updateRotation(Math.min(360, plantRotation + 0.1));
    });
    
    // Funzione per aggiornare scala
    function updateScale(value) {
      plantScale = parseFloat(value) / 100;
      const displayValue = parseFloat(value).toFixed(1);
      document.getElementById('plant-scale-value').textContent = displayValue + '%';
      document.getElementById('plant-scale').value = value;
      document.getElementById('plant-scale-input').value = value;
      updatePlantOverlay();
    }
    
    // Slider scala pianta
    document.getElementById('plant-scale').addEventListener('input', (e) => {
      updateScale(e.target.value);
    });
    
    // Input numerico scala
    document.getElementById('plant-scale-input').addEventListener('input', (e) => {
      updateScale(e.target.value);
    });
    
    // Pulsanti +/- scala (0.1% alla volta)
    document.getElementById('btn-scale-minus').addEventListener('click', () => {
      const newValue = Math.max(1, parseFloat(document.getElementById('plant-scale').value) - 0.1);
      updateScale(newValue);
    });
    
    document.getElementById('btn-scale-plus').addEventListener('click', () => {
      const newValue = Math.min(500, parseFloat(document.getElementById('plant-scale').value) + 0.1);
      updateScale(newValue);
    });
    
    // Slider opacit√† pianta
    document.getElementById('plant-opacity').addEventListener('input', (e) => {
      document.getElementById('plant-opacity-value').textContent = e.target.value + '%';
      if (pdfOverlay) {
        pdfOverlay.setOpacity(parseInt(e.target.value) / 100);
      }
    });
    
    // Centra pianta
    document.getElementById('btn-center-plant').addEventListener('click', () => {
      if (!pdfBlob) {
        alert('‚ö†Ô∏è Carica prima una pianta!');
        return;
      }
      map.setView([42.7589, 11.1135], 17);
      updatePlantOverlay();
    });
    
    // Slider rotazione posteggi
    document.getElementById('slot-rotation').addEventListener('input', (e) => {
      slotRotation = parseInt(e.target.value);
      document.getElementById('slot-rotation-value').textContent = slotRotation + '¬∞';
      // Aggiorna tutti i posteggi esistenti
      slots.forEach(slot => {
        if (slot.marker) {
          const elem = slot.marker.getElement();
          if (elem) {
            elem.style.transform = `rotate(${slotRotation}deg)`;
          }
        }
      });
    });
    
    // Modalit√† aggiungi posteggio
    document.getElementById('btn-add-mode').addEventListener('click', function() {
      addMode = !addMode;
      this.textContent = addMode ? 'üõë Disattiva Modalit√†' : 'üìç Modalit√† Aggiungi Posteggio';
      this.className = addMode ? 'danger' : 'active';
      map.getContainer().style.cursor = addMode ? 'crosshair' : '';
    });
    
    // Click sulla mappa per aggiungere posteggio
    map.on('click', (e) => {
      if (!addMode) return;
      
      const width = parseFloat(document.getElementById('slot-width').value);
      const height = parseFloat(document.getElementById('slot-height').value);
      const keepDim = document.getElementById('keep-dimensions').checked;
      
      // Crea marker posteggio
      const marker = L.marker(e.latlng, {
        icon: L.divIcon({
          className: 'slot-marker',
          html: `<div style="transform: rotate(${slotRotation}deg); width: 100%; height: 100%;">${slotCounter}</div>`,
          iconSize: [keepDim ? 30 : width * 5, keepDim ? 50 : height * 5],
          iconAnchor: [keepDim ? 15 : width * 2.5, keepDim ? 25 : height * 2.5]
        }),
        draggable: true
      }).addTo(map);
      
      const slot = {
        number: slotCounter,
        lat: e.latlng.lat,
        lng: e.latlng.lng,
        width: width,
        height: height,
        rotation: slotRotation,
        marker: marker
      };
      
      slots.push(slot);
      slotCounter++;
      
      updateSlotList();
      DMSConsole.log(`‚úÖ Posteggio ${slot.number} aggiunto`);
    });
    
    // Aggiorna lista posteggi
    function updateSlotList() {
      const list = document.getElementById('slot-list');
      const count = document.getElementById('slot-count');
      const total = document.getElementById('total-slots');
      
      count.textContent = `${slots.length} posteggi aggiunti`;
      total.textContent = slots.length;
      
      if (slots.length === 0) {
        list.innerHTML = '<div style="opacity: 0.6;">Nessun posteggio</div>';
        return;
      }
      
      list.innerHTML = slots.map(slot => `
        <div class="slot-item">
          <span>Posteggio ${slot.number} (${slot.width}m √ó ${slot.height}m)</span>
          <button onclick="removeSlot(${slot.number})">‚ùå</button>
        </div>
      `).join('');
    }
    
    // Rimuovi posteggio
    window.removeSlot = function(number) {
      const index = slots.findIndex(s => s.number === number);
      if (index !== -1) {
        map.removeLayer(slots[index].marker);
        slots.splice(index, 1);
        updateSlotList();
        DMSConsole.log(`üóëÔ∏è Posteggio ${number} rimosso`);
      }
    };
    
    // Cancella tutti
    document.getElementById('btn-clear-all').addEventListener('click', () => {
      if (!confirm('‚ö†Ô∏è Cancellare tutti i posteggi?')) return;
      
      slots.forEach(slot => map.removeLayer(slot.marker));
      slots = [];
      slotCounter = 1;
      updateSlotList();
      DMSConsole.log('üóëÔ∏è Tutti i posteggi cancellati');
    });
    
    // Esporta GeoJSON
    document.getElementById('btn-export-json').addEventListener('click', () => {
      if (slots.length === 0) {
        alert('‚ö†Ô∏è Aggiungi almeno un posteggio prima di esportare!');
        return;
      }
      
      if (!plantBounds) {
        alert('‚ö†Ô∏è Carica e posiziona la pianta prima di esportare!');
        return;
      }
      
      // Cattura 4 corner della pianta
      const corners = [
        [plantBounds.getNorthWest().lat, plantBounds.getNorthWest().lng],
        [plantBounds.getNorthEast().lat, plantBounds.getNorthEast().lng],
        [plantBounds.getSouthEast().lat, plantBounds.getSouthEast().lng],
        [plantBounds.getSouthWest().lat, plantBounds.getSouthWest().lng]
      ];
      
      // Crea GeoJSON posteggi
      const stallsGeoJSON = {
        type: 'FeatureCollection',
        features: slots.map(slot => ({
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: [slot.lng, slot.lat]
          },
          properties: {
            number: slot.number,
            orientation: slot.rotation,
            kind: 'slot',
            status: 'free',
            dimensions: `${slot.width}m √ó ${slot.height}m`
          }
        }))
      };
      
      // Crea JSON completo
      const exportData = {
        container: corners,
        stalls_geojson: stallsGeoJSON,
        plant_rotation: plantRotation,
        plant_scale: plantScale,
        timestamp: new Date().toISOString()
      };
      
      // Download
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mercato-esperanto-${slots.length}-posteggi-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      document.getElementById('export-status').textContent = `‚úÖ ${slots.length} posteggi esportati!`;
      DMSConsole.log(`‚úÖ JSON esportato con ${slots.length} posteggi e 4 corner`);
    });
    
    // Salva nel Bus
    document.getElementById('btn-save-bus').addEventListener('click', async () => {
      if (slots.length === 0) {
        alert('‚ö†Ô∏è Aggiungi almeno un posteggio prima di salvare!');
        return;
      }
      
      try {
        // Salva posteggi
        const stallsGeoJSON = {
          type: 'FeatureCollection',
          features: slots.map(slot => ({
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [slot.lng, slot.lat]
            },
            properties: {
              number: slot.number,
              orientation: slot.rotation,
              kind: 'slot',
              status: 'free',
              dimensions: `${slot.width}m √ó ${slot.height}m`
            }
          }))
        };
        
        await DMSBUS.setJSON('stalls_geojson', stallsGeoJSON);
        
        // Salva container se disponibile
        if (plantBounds) {
          const corners = [
            [plantBounds.getNorthWest().lat, plantBounds.getNorthWest().lng],
            [plantBounds.getNorthEast().lat, plantBounds.getNorthEast().lng],
            [plantBounds.getSouthEast().lat, plantBounds.getSouthEast().lng],
            [plantBounds.getSouthWest().lat, plantBounds.getSouthWest().lng]
          ];
          await DMSBUS.setJSON('container', corners);
        }
        
        // Salva PNG se disponibile
        if (pdfBlob) {
          await DMSBUS.setBlob('png_transparent', pdfBlob);
        }
        
        document.getElementById('export-status').textContent = `‚úÖ Salvato nel Bus!`;
        DMSConsole.log(`‚úÖ ${slots.length} posteggi salvati nel BUS`);
        alert(`‚úÖ ${slots.length} posteggi salvati nel BUS!`);
      } catch (err) {
        alert('‚ùå Errore salvataggio: ' + err.message);
        DMSConsole.log('‚ùå Errore: ' + err.message);
      }
    });
  </script>
</body>
</html>
