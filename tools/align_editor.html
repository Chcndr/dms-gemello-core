<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DMS GIS ‚Äî Allineatore (ruota/scala/centra)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{--panel:#0f2330;--txt:#eaf1f5;--mut:#9fb1be;--acc:#1f8f5f}
  html,body,#map{height:100%;margin:0}
  #map{position:relative;z-index:1}
  
  .ui{
    position:fixed; top:12px; left:12px; z-index:10000;
    width:360px; max-width:min(92vw,420px); max-height:calc(100% - 24px);
    overflow:auto; background:var(--panel); color:var(--txt);
    padding:14px; border-radius:12px;
    box-shadow:0 10px 28px rgba(0,0,0,.35);
    font:14px system-ui;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{background:var(--acc);border:0;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer;flex:1}
  .btn.secondary{background:#2b3c48}
  .btn.danger{background:#b84040}
  .btn.zoom{background:#ff9800;flex:0 0 auto;min-width:44px;font-size:18px;font-weight:bold}
  .btn:disabled{opacity:0.5;cursor:not-allowed}
  .mut{color:var(--mut)} .small{font-size:12px}
  .group{border-top:1px solid #1a2d3a;margin-top:10px;padding-top:10px}
  
  input[type=range]{width:100%;margin:6px 0}
  label{display:block;margin-top:8px;font-size:13px}
  
  /* Overlay draggable */
  .leaflet-image-layer.draggable {
    cursor: move !important;
  }
</style>
</head>
<body>
<div id="map"></div>

<div class="ui">
  <h3 style="margin:0 0 6px">üéØ Allineatore</h3>
  <div class="small mut">Ruota, scala e centra l'immagine sulla mappa. NO distorsioni.</div>

  <div class="group">
    <b>1. Carica PNG dal Bus</b>
    <div class="row">
      <button class="btn secondary" id="loadFromBus">üì• Carica dal Bus</button>
    </div>
    <div class="small mut" id="loadStatus">In attesa...</div>
  </div>

  <div class="group">
    <b>2. Allinea Immagine</b>
    
    <label>Rotazione: <span id="rotVal">0</span>¬∞</label>
    <div class="row">
      <button class="btn zoom" id="rotMinus">‚àí</button>
      <input type="range" id="rotation" min="0" max="360" value="0" step="1" style="flex:1"/>
      <button class="btn zoom" id="rotPlus">+</button>
    </div>
    
    <label>Scala: <span id="scaleVal">1.0</span>x</label>
    <div class="row">
      <button class="btn zoom" id="zoomOut">‚àí</button>
      <input type="range" id="scale" min="0.1" max="5" value="1" step="0.1" style="flex:1"/>
      <button class="btn zoom" id="zoomIn">+</button>
    </div>
    
    <label>Opacit√†: <span id="opVal">0.70</span></label>
    <div class="row">
      <button class="btn zoom" id="opMinus">‚àí</button>
      <input type="range" id="opacity" min="0" max="1" value="0.7" step="0.05" style="flex:1"/>
      <button class="btn zoom" id="opPlus">+</button>
    </div>
    
    <label>Zoom Mappa</label>
    <div class="row">
      <button class="btn zoom" id="mapZoomOut">‚àí</button>
      <button class="btn secondary" style="flex:1" id="centerOnMap">üìç Centra</button>
      <button class="btn zoom" id="mapZoomIn">+</button>
    </div>
    
    <div class="row" style="margin-top:8px">
      <button class="btn secondary" id="resetTransform">‚Üª Reset Trasformazioni</button>
    </div>
    
    <div class="small mut" style="margin-top:8px">
      <b>Trascina l'immagine</b> per posizionarla. Usa i controlli per allineare.
    </div>
  </div>

  <div class="group">
    <b>3. Salva GCP ed Esporta</b>
    <div class="row">
      <button class="btn" id="saveGCP" disabled>üíæ Salva GCP nel Bus</button>
      <button class="btn secondary" id="openContainerKit" disabled>‚û°Ô∏è Container Kit</button>
    </div>
    <div class="small mut" id="gcpStatus">Posiziona l'immagine prima di salvare.</div>
  </div>

  <div class="group">
    <b>Debug</b>
    <div class="small mut" id="debug">...</div>
  </div>
</div>

<script src="../shared/dms-bus.js"></script>
<script>
// Mappa
const map = L.map('map', {
  zoomControl: false // Rimuoviamo i controlli default, usiamo i nostri
}).setView([42.7633, 11.1117], 16);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 20,
  attribution: '¬© OSM'
}).addTo(map);

// Elementi UI
const loadStatus = document.getElementById('loadStatus');
const gcpStatus = document.getElementById('gcpStatus');
const debugEl = document.getElementById('debug');
const rotInput = document.getElementById('rotation');
const scaleInput = document.getElementById('scale');
const opInput = document.getElementById('opacity');
const rotVal = document.getElementById('rotVal');
const scaleVal = document.getElementById('scaleVal');
const opVal = document.getElementById('opVal');
const saveBtn = document.getElementById('saveGCP');
const openKitBtn = document.getElementById('openContainerKit');

// Stato
let imageOverlay = null;
let imageElement = null;
let imageSize = {w: 0, h: 0};
let currentRotation = 0;
let currentScale = 1.0;
let currentOpacity = 0.7;
let isDragging = false;
let dragStart = {x: 0, y: 0};
let imagePosition = {x: 0, y: 0}; // Offset in pixel

// Funzioni di log
function log(msg) {
  debugEl.textContent = `[${new Date().toTimeString().slice(0,8)}] ${msg}`;
}

// Applica trasformazioni CSS
function applyTransform() {
  if (!imageElement) return;
  
  const transform = `translate(${imagePosition.x}px, ${imagePosition.y}px) rotate(${currentRotation}deg) scale(${currentScale})`;
  imageElement.style.transform = transform;
  imageElement.style.transformOrigin = 'center';
  imageElement.style.opacity = currentOpacity;
}

// 1. Carica PNG dal Bus
document.getElementById('loadFromBus').onclick = async () => {
  try {
    const blob = await DMSBUS.getBlob('png_transparent');
    const meta = await DMSBUS.getJSON('png_meta');
    
    if (!blob) {
      loadStatus.textContent = '‚ùå Nessun PNG nel bus. Usa prima "PNG Trasparente".';
      return;
    }
    
    imageSize = meta || {w: 1000, h: 800};
    loadStatus.textContent = `‚úÖ PNG caricato (${imageSize.w}x${imageSize.h})`;
    
    // Crea URL da Blob
    const url = URL.createObjectURL(blob);
    
    // Rimuovi overlay precedente
    if (imageOverlay) {
      map.removeLayer(imageOverlay);
    }
    
    // Reset posizione
    imagePosition = {x: 0, y: 0};
    currentRotation = 0;
    currentScale = 1.0;
    currentOpacity = 0.7;
    
    rotInput.value = 0;
    scaleInput.value = 1;
    opInput.value = 0.7;
    rotVal.textContent = '0';
    scaleVal.textContent = '1.0';
    opVal.textContent = '0.70';
    
    // Centro mappa
    const center = map.getCenter();
    
    // Calcola dimensione overlay: max 400px sulla mappa
    const maxSize = 400;
    const ratio = Math.max(imageSize.w, imageSize.h) / maxSize;
    const displayW = imageSize.w / ratio;
    const displayH = imageSize.h / ratio;
    
    // Crea bounds centrati
    const metersPerPixel = 156543.03392 * Math.cos(center.lat * Math.PI / 180) / Math.pow(2, map.getZoom());
    const widthMeters = displayW * metersPerPixel;
    const heightMeters = displayH * metersPerPixel;
    
    const latOffset = (heightMeters / 111320) / 2;
    const lngOffset = (widthMeters / (111320 * Math.cos(center.lat * Math.PI / 180))) / 2;
    
    const bounds = [
      [center.lat - latOffset, center.lng - lngOffset],
      [center.lat + latOffset, center.lng + lngOffset]
    ];
    
    // Crea overlay
    imageOverlay = L.imageOverlay(url, bounds, {
      opacity: currentOpacity,
      interactive: true,
      className: 'draggable'
    }).addTo(map);
    
    // Aspetta che l'elemento sia nel DOM
    setTimeout(() => {
      imageElement = imageOverlay.getElement();
      if (imageElement) {
        imageElement.style.cursor = 'move';
        
        // Eventi drag
        imageElement.addEventListener('mousedown', onDragStart);
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', onDragEnd);
        
        log('Immagine caricata. Trascina per posizionare!');
      }
    }, 100);
    
    saveBtn.disabled = false;
    openKitBtn.disabled = false;
    gcpStatus.textContent = 'Immagine pronta. Allinea e salva GCP.';
    
  } catch (err) {
    loadStatus.textContent = `‚ùå Errore: ${err.message}`;
    log(`Errore caricamento: ${err}`);
  }
};

// Drag handlers
function onDragStart(e) {
  if (!imageElement) return;
  isDragging = true;
  dragStart = {
    x: e.clientX - imagePosition.x,
    y: e.clientY - imagePosition.y
  };
  imageElement.style.cursor = 'grabbing';
  e.preventDefault();
}

function onDrag(e) {
  if (!isDragging) return;
  imagePosition = {
    x: e.clientX - dragStart.x,
    y: e.clientY - dragStart.y
  };
  applyTransform();
}

function onDragEnd() {
  if (!isDragging) return;
  isDragging = false;
  if (imageElement) {
    imageElement.style.cursor = 'move';
  }
  log(`Posizione: x=${imagePosition.x}, y=${imagePosition.y}`);
}

// 2. Controlli trasformazione

// Rotazione
rotInput.oninput = () => {
  currentRotation = parseFloat(rotInput.value);
  rotVal.textContent = currentRotation;
  applyTransform();
};

document.getElementById('rotPlus').onclick = () => {
  currentRotation = (currentRotation + 5) % 360;
  rotInput.value = currentRotation;
  rotVal.textContent = currentRotation;
  applyTransform();
};

document.getElementById('rotMinus').onclick = () => {
  currentRotation = (currentRotation - 5 + 360) % 360;
  rotInput.value = currentRotation;
  rotVal.textContent = currentRotation;
  applyTransform();
};

// Scala
scaleInput.oninput = () => {
  currentScale = parseFloat(scaleInput.value);
  scaleVal.textContent = currentScale.toFixed(1);
  applyTransform();
};

document.getElementById('zoomIn').onclick = () => {
  currentScale = Math.min(5, currentScale + 0.1);
  scaleInput.value = currentScale;
  scaleVal.textContent = currentScale.toFixed(1);
  applyTransform();
};

document.getElementById('zoomOut').onclick = () => {
  currentScale = Math.max(0.1, currentScale - 0.1);
  scaleInput.value = currentScale;
  scaleVal.textContent = currentScale.toFixed(1);
  applyTransform();
};

// Opacit√†
opInput.oninput = () => {
  currentOpacity = parseFloat(opInput.value);
  opVal.textContent = currentOpacity.toFixed(2);
  applyTransform();
};

document.getElementById('opPlus').onclick = () => {
  currentOpacity = Math.min(1, currentOpacity + 0.05);
  opInput.value = currentOpacity;
  opVal.textContent = currentOpacity.toFixed(2);
  applyTransform();
};

document.getElementById('opMinus').onclick = () => {
  currentOpacity = Math.max(0, currentOpacity - 0.05);
  opInput.value = currentOpacity;
  opVal.textContent = currentOpacity.toFixed(2);
  applyTransform();
};

// Zoom mappa
document.getElementById('mapZoomIn').onclick = () => {
  map.zoomIn();
  log('Zoom mappa +');
};

document.getElementById('mapZoomOut').onclick = () => {
  map.zoomOut();
  log('Zoom mappa -');
};

document.getElementById('resetTransform').onclick = () => {
  imagePosition = {x: 0, y: 0};
  currentRotation = 0;
  currentScale = 1.0;
  currentOpacity = 0.7;
  
  rotInput.value = 0;
  scaleInput.value = 1;
  opInput.value = 0.7;
  rotVal.textContent = '0';
  scaleVal.textContent = '1.0';
  opVal.textContent = '0.70';
  
  applyTransform();
  log('Reset trasformazioni');
};

document.getElementById('centerOnMap').onclick = () => {
  if (imageOverlay) {
    map.fitBounds(imageOverlay.getBounds());
    log('Centrato su mappa');
  }
};

// 3. Salva GCP
document.getElementById('saveGCP').onclick = async () => {
  if (!imageOverlay || !imageElement) {
    alert('Nessuna immagine caricata!');
    return;
  }
  
  try {
    // Ottieni i 4 angoli dell'immagine in coordinate geografiche
    // Usa i bounds originali dell'overlay e applica le trasformazioni
    const bounds = imageOverlay.getBounds();
    const sw = bounds.getSouthWest();
    const ne = bounds.getNorthEast();
    const nw = L.latLng(ne.lat, sw.lng);
    const se = L.latLng(sw.lat, ne.lng);
    
    // Calcola il centro dell'immagine in coordinate schermo
    const centerPoint = map.latLngToContainerPoint(bounds.getCenter());
    
    // Applica offset dal drag
    const transformedCenter = {
      x: centerPoint.x + imagePosition.x,
      y: centerPoint.y + imagePosition.y
    };
    
    // Converti il centro trasformato in lat/lng
    const transformedLatLng = map.containerPointToLatLng(transformedCenter);
    
    // Calcola i 4 angoli ruotati e scalati
    const halfW = (ne.lng - sw.lng) * currentScale / 2;
    const halfH = (ne.lat - sw.lat) * currentScale / 2;
    
    const corners = {
      nw: [transformedLatLng.lat + halfH, transformedLatLng.lng - halfW],
      ne: [transformedLatLng.lat + halfH, transformedLatLng.lng + halfW],
      sw: [transformedLatLng.lat - halfH, transformedLatLng.lng - halfW],
      se: [transformedLatLng.lat - halfH, transformedLatLng.lng + halfW]
    };
    
    // GCP: 4 angoli (NW, NE, SW, SE) con coordinate pixel e geografiche
    const gcp = {
      corners: [
        {px: [0, 0], ll: corners.nw},
        {px: [imageSize.w, 0], ll: corners.ne},
        {px: [0, imageSize.h], ll: corners.sw},
        {px: [imageSize.w, imageSize.h], ll: corners.se}
      ],
      imageW: imageSize.w,
      imageH: imageSize.h,
      rotation: currentRotation,
      scale: currentScale,
      center: [transformedLatLng.lat, transformedLatLng.lng]
    };
    
    await DMSBUS.putJSON('gcp', gcp);
    gcpStatus.textContent = '‚úÖ GCP salvati nel bus!';
    log('GCP salvati');
    alert('‚úÖ GCP salvati nel bus!');
    
  } catch (err) {
    alert('‚ùå Errore: ' + err.message);
    log('Errore salvataggio GCP: ' + err);
  }
};

document.getElementById('openContainerKit').onclick = () => {
  window.open('container_kit.html', '_blank');
};
</script>
</body>
</html>

